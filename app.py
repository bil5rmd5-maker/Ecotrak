import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงููููุฉ ุงูุจุตุฑูุฉ ุงููุชุทูุฑุฉ
st.set_page_config(page_title="Ecotrak Neural ERP", layout="wide", page_icon="๐ง")

st.markdown("""
    <style>
    .stDataFrame { border: 2px solid #4A90E2; border-radius: 10px; }
    .stMetric { background: #f8f9fa; border-left: 5px solid #4A90E2; }
    </style>
    """, unsafe_allow_html=True)

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ
if 'products_df' not in st.session_state:
    st.session_state.products_df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ูุญุฑูุงุช ุชูุฑุจูููุฉ', 'ุงูุณุญุจ_ุงููููู': 12, 'ุงููุฎุฒูู': 45, 'ุงูุณุนุฑ': 8000, 'ุชูููุฉ_ุงูุทูุจ': 1200, 'ุชูููุฉ_ุงูุชุฎุฒูู': 200, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 10},
        {'ุงูููุชุฌ': 'ูุญุฏุงุช ูุนุงูุฌุฉ', 'ุงูุณุญุจ_ุงููููู': 35, 'ุงููุฎุฒูู': 120, 'ุงูุณุนุฑ': 1500, 'ุชูููุฉ_ุงูุทูุจ': 300, 'ุชูููุฉ_ุงูุชุฎุฒูู': 45, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 5},
        {'ุงูููุชุฌ': 'ูุณุชุดุนุฑุงุช ููุฒุฑ', 'ุงูุณุญุจ_ุงููููู': 50, 'ุงููุฎุฒูู': 300, 'ุงูุณุนุฑ': 450, 'ุชูููุฉ_ุงูุทูุจ': 100, 'ุชูููุฉ_ุงูุชุฎุฒูู': 15, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 3}
    ])

# 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููุชููู
st.sidebar.title("๐ง Ecotrak Neural ERP")
menu = st.sidebar.radio("ุงูููุธููุงุช ุงูุชูููุฉ:", 
    ["๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ุงูุฌุฏุงูู)", "๐ ุงูุชูุฃู ุงูุฑููู", "๐ฎ ูุญุงูู ุงูุณููุงุฑูููุงุช", "๐ ููุธููุฉ ุงูููุฑุฏูู ุงูุฐููุฉ", "๐ฑ ุงูุงุณุชุฏุงูุฉ"])

# --- ุงููุงุฆูุฉ 1: ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ุงูุฌุฏูู ุงูุชูุงุนูู) ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ุงูุฌุฏุงูู)":
    st.header("๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุชูุงุนููุฉ ููุฃุตูุงู")
    st.write("ููููู ุชุนุฏูู ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ูู ุงูุฌุฏูู (ุงููุฎุฒููุ ุงูุณุญุจุ ุงูุณุนุฑ) ูุณูููู ุงููุธุงู ุจุชุญุฏูุซ ุงูุชุญูููุงุช ููุฑุงู.")
    
    # ุงุณุชุฎุฏุงู st.data_editor ููุณูุงุญ ุจุงูุชุนุฏูู ุงููุจุงุดุฑ
    edited_df = st.data_editor(st.session_state.products_df, num_rows="dynamic", use_container_width=True)
    
    if st.button("ุญูุธ ุงูุชุบููุฑุงุช ูุชุญุฏูุซ ุงููุธุงู"):
        st.session_state.products_df = edited_df
        st.success("โ ุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ!")

# --- ุงููุงุฆูุฉ 2: ุงูุชูุฃู ุงูุฑููู (ุชุญููู ุฃุฏุงุก ุงูุตูู) ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู":
    st.header("๐ ุงูุชุญููู ุงููุญุธู ูุฏุนู ุงููุฑุงุฑ")
    p_names = st.session_state.products_df['ุงูููุชุฌ'].tolist()
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ููุชุญููู:", p_names)
    p = st.session_state.products_df[st.session_state.products_df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    # ุญุณุงุจุงุช EOQ
    eoq = np.sqrt((2 * p['ุงูุณุญุจ_ุงููููู'] * 365 * p['ุชูููุฉ_ุงูุทูุจ']) / p['ุชูููุฉ_ุงูุชุฎุฒูู'])
    days_left = p['ุงููุฎุฒูู'] / p['ุงูุณุญุจ_ุงููููู']
    
    c1, c2, c3 = st.columns(3)
    c1.metric("ุงููุฎุฒูู ุงูุญุงูู", f"{p['ุงููุฎุฒูู']} ูุทุนุฉ")
    c2.metric("ุฃูุงู ุงูุชุบุทูุฉ", f"{int(days_left)} ููู")
    c3.metric("ุงููููุฉ ุงูุงูุชุตุงุฏูุฉ (EOQ)", f"{int(eoq)} ูุญุฏุฉ")
    
    # ุงูุฑุณู ุงูุจูุงูู
    fig = go.Figure(go.Indicator(
        mode = "gauge+number", value = p['ุงููุฎุฒูู'],
        gauge = {'axis': {'range': [0, eoq*1.5]}, 'steps': [{'range': [0, p['ุงูุณุญุจ_ุงููููู']*p['ูุฏุฉ_ุงูุชูุฑูุฏ']], 'color': "red"}]}))
    st.plotly_chart(fig, use_container_width=True)

# --- ุงููุงุฆูุฉ 3: ูุญุงูู ุงูุณููุงุฑูููุงุช ---
elif menu == "๐ฎ ูุญุงูู ุงูุณููุงุฑูููุงุช":
    st.header("๐ฎ ูุนูู ูุญุงูุงุฉ ุงูุงุญุชูุงูุงุช (What-If)")
    sel_p = st.selectbox("ุตูู ุงููุญุงูุงุฉ:", st.session_state.products_df['ุงูููุชุฌ'])
    p = st.session_state.products_df[st.session_state.products_df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    col_in, col_out = st.columns([1, 2])
    with col_in:
        st.subheader("๐๏ธ ุงููุฏุฎูุงุช")
        price_change = st.slider("ุชุนุฏูู ุงูุณุนุฑ (%)", -50, 50, 0)
        ship_cost = st.slider("ุชูููุฉ ุงูุดุญู (S)", 50, 5000, int(p['ุชูููุฉ_ุงูุทูุจ']))
        
        new_price = p['ุงูุณุนุฑ'] * (1 + price_change/100)
        new_sales = p['ุงูุณุญุจ_ุงููููู'] / ((new_price / p['ุงูุณุนุฑ']) ** 1.5)
        new_eoq = np.sqrt((2 * new_sales * 365 * ship_cost) / p['ุชูููุฉ_ุงูุชุฎุฒูู'])

    with col_out:
        st.subheader("๐ ุงููุชุงุฆุฌ ุงูุชูุจุคูุฉ")
        st.write(f"ุงููุจูุนุงุช ุงููุชููุนุฉ: **{new_sales:.1f}** ููููุงู")
        st.write(f"ุงููููุฉ ุงููุทููุจุฉ ููุทูุจ ุงููุงุฏู: **{int(new_eoq)}** ูุทุนุฉ")
        st.markdown(f"๐ค **ูุตูุญุฉ:** {'ุฎูุถ ุงูุณุนุฑ ุณูุฑูู ุงููุณุชูุฏุนุงุชุ ุงุฑูุน ุณุนุฉ ุงูุชุฎุฒูู!' if price_change < 0 else 'ุฑูุน ุงูุณุนุฑ ุณูููู ุฏูุฑุงู ุงูุจุถุงุนุฉุ ููู ุญุฌู ุงูุทูุจุงุช.'}")

# --- ุงููุงุฆูุฉ 4: ููุธููุฉ ุงูููุฑุฏูู ุงูุฐููุฉ (ุฎูุงุฑุงุช ูุชูุฏูุฉ) ---
elif menu == "๐ ููุธููุฉ ุงูููุฑุฏูู ุงูุฐููุฉ":
    st.header("๐ ุฑุงุฏุงุฑ ุชูููู ูุงุฎุชูุงุฑ ุงูููุฑุฏูู")
    st.write("ูุงุฑู ุจูู ุงูููุฑุฏูู ุจูุงุกู ุนูู (ุงูุฌูุฏุฉุ ุงูุณุนุฑุ ุงูุณุฑุนุฉุ ูุงูุงุณุชุฏุงูุฉ).")
    
    vendors = pd.DataFrame({
        'ุงูููุฑุฏ': ['ููุฑุฏ ูุญูู (ุฌุฏุฉ)', 'ููุฑุฏ ุฅููููู (ุฏุจู)', 'ููุฑุฏ ุฏููู (ุดูุบูุงู)', 'ููุฑุฏ ุฃููุงูู (ูููููุฎ)'],
        'ุงูุณุฑุนุฉ_ุฃูุงู': [2, 7, 25, 14],
        'ุงูุชูููุฉ_ุดุญู': [500, 1200, 200, 3000],
        'ุงูุฌูุฏุฉ_100': [85, 90, 75, 98],
        'ุงูุจุตูุฉ_ุงููุฑุจูููุฉ': ['ููุฎูุถุฉ', 'ูุชูุณุทุฉ', 'ุนุงููุฉ', 'ููุฎูุถุฉ']
    })
    
    st.dataframe(vendors, use_container_width=True)
    
    # ุงุฎุชูุงุฑ ุงูููุฑุฏ ุงูุฃูุณุจ
    v_choice = st.selectbox("ุจูุงุกู ุนูู ุงูุตูู ุงููุฎุชุงุฑุ ุฃู ููุฑุฏ ุชูุถูุ", vendors['ุงูููุฑุฏ'])
    v_data = vendors[vendors['ุงูููุฑุฏ'] == v_choice].iloc[0]
    
    st.info(f"๐ก **ุชุญููู ุงูููุฌุณุชูุงุช:** ุงุฎุชูุงุฑู ูู {v_choice} ุณูููุฑ ูู ุฌูุฏุฉ ุจูุณุจุฉ {v_data['ุงูุฌูุฏุฉ_100']}%ุ ูููู ุชุฐูุฑ ุฃู ูุฏุฉ ุงูุชูุตูู ({v_data['ุงูุณุฑุนุฉ_ุฃูุงู']} ุฃูุงู) ุชุชุทูุจ ููู ุทูุจ ุงูุจุถุงุนุฉ ูุจูุฑุงู.")

# --- ุงููุงุฆูุฉ 5: ุงูุงุณุชุฏุงูุฉ ---
elif menu == "๐ฑ ุงูุงุณุชุฏุงูุฉ":
    st.header("๐ฑ ูุฑูุฒ ุงูุงุณุชุฏุงูุฉ ูุฑุคูุฉ 2030")
    st.metric("ุชูููุฑ ุงูุงูุจุนุงุซุงุช ุงููุฑุจูููุฉ", "24.5 ูุฌู", "+15%")
    st.success("๐ค ุชุญุณูู ุณูุงุณู ุงูุฅูุฏุงุฏ ุนุจุฑ Ecotrak ูููู ูู ุฑุญูุงุช ุงูููู ุบูุฑ ุงูุถุฑูุฑูุฉุ ููุง ูููู ุงูุจุตูุฉ ุงูุจูุฆูุฉ ููุตูุนู.")
