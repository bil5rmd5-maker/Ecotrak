import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ (ูุฌุจ ุฃู ุชููู ุฃูู ุณุทุฑ)
st.set_page_config(page_title="Ecotrak Dynamic ERP", layout="wide", page_icon="๐งฌ")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ (Neural State)
if 'db' not in st.session_state:
    st.session_state.db = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุตุงุจูู ูุงููุฏุฑ ุนุถูู', 'ุงูุณุญุจ': 45, 'ุงููุฎุฒูู': 350, 'ุงูุณุนุฑ': 25.0, 'ุงูุชูููุฉ': 12.0, 'ุงูุดุญู_S': 150.0, 'ุงูุชุฎุฒูู_H': 2.0, 'ุงูุชูู_%': 3.0, 'LT': 3},
        {'ุงูููุชุฌ': 'ููุธู ุฃูุงูู ููููู', 'ุงูุณุญุจ': 110, 'ุงููุฎุฒูู': 200, 'ุงูุณุนุฑ': 15.0, 'ุงูุชูููุฉ': 7.0, 'ุงูุดุญู_S': 80.0, 'ุงูุชุฎุฒูู_H': 1.0, 'ุงูุชูู_%': 1.5, 'LT': 2}
    ])

# --- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ---
st.sidebar.title("๐งฌ Ecotrak Dynamic AI")
menu = st.sidebar.radio("ุงูููุงุฆู ุงููุชุฑุงุจุทุฉ:", 
    ["๐ ุฅุฏุงุฑุฉ ุงูุชูุงููู ูุงูุฃุตูู", "๐ ุงูุชูุฃู ุงูุฑููู ุงูุชูุงุนูู", "๐ ุงูููุงุชูุฑ ูุงูุฑุจุญูุฉ", "๐ก ูุณุชุดุงุฑ AI ุงูุงุณุชุฑุงุชูุฌู"], 
    key="nav_v13")

# ูุธููุฉ ูุญุณุงุจ EOQ ุฏููุงููููุงู
def calc_eoq(d, s, h):
    return np.sqrt((2 * d * 365 * s) / h) if h > 0 else 0

# --- 1. ุฅุฏุงุฑุฉ ุงูุชูุงููู (ูุฑูุฒ ุงูุชุญูู ุงูุฑุฆูุณู) ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูุชูุงููู ูุงูุฃุตูู":
    st.header("๐ ููุฏุณุฉ ุงูุชูุงููู ูุงูุฃุตูู")
    st.info("๐ก ุฃู ุชุนุฏูู ููุง ุณูุคุซุฑ ููุฑุงู ุนูู ูููุงุช ุงูุทูุจุ ุงูุฃุฑุจุงุญุ ููุตุงุฆุญ ุงูุฐูุงุก ุงูุงุตุทูุงุนู.")
    
    edited_df = st.data_editor(st.session_state.db, num_rows="dynamic", use_container_width=True, key="main_editor_v13")
    
    if st.button("๐ ุชุญุฏูุซ ููุฒุงููุฉ ุงููุญุฑู ุงููุงูู", key="sync_btn"):
        st.session_state.db = edited_df
        st.success("ุชูุช ุฅุนุงุฏุฉ ูุนุงูุฑุฉ ุงููุธุงู ุจูุงุกู ุนูู ุงูุชูุงููู ุงูุฌุฏูุฏุฉ!")
        st.rerun()

# --- 2. ุงูุชูุฃู ุงูุฑููู (ูุชุฃุซุฑ ุจุชูููุฉ ุงูุดุญู ูุงูุชุฎุฒูู) ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู ุงูุชูุงุนูู":
    st.header("๐ ุงููุญุงูุงุฉ ุงููุญุธูุฉ (ุชุฃุซูุฑ ุงูุชูุงููู ุนูู ุงููููุงุช)")
    df = st.session_state.db
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ูููุนุงููุฉ:", df['ุงูููุชุฌ'].unique(), key="twin_sel")
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    # ุญุณุงุจ EOQ ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงููุนุฏูุฉ
    eoq = calc_eoq(p['ุงูุณุญุจ'], p['ุงูุดุญู_S'], p['ุงูุชุฎุฒูู_H'])
    rop = p['ุงูุณุญุจ'] * p['LT']
    
    c1, c2, c3 = st.columns(3)
    c1.metric("ุงููููุฉ ุงูุงูุชุตุงุฏูุฉ (EOQ)", f"{int(eoq)} ูุญุฏุฉ", help="ุชุชุฃุซุฑ ุจุชูููุฉ ุงูุดุญู ูุงูุชุฎุฒูู")
    c2.metric("ุชูููุฉ ุงูุทูุจูุฉ ุงููุงุญุฏุฉ", f"{p['ุงูุดุญู_S']} ุฑูุงู")
    c3.metric("ุชูููุฉ ุชุฎุฒูู ุงููุทุนุฉ/ุณูุฉ", f"{p['ุงูุชุฎุฒูู_H']} ุฑูุงู")
    
    fig = go.Figure(go.Indicator(
        mode = "gauge+number", value = p['ุงููุฎุฒูู'],
        gauge = {
            'axis': {'range': [0, max(eoq*1.2, p['ุงููุฎุฒูู']*1.2)]},
            'steps': [{'range': [0, rop], 'color': "red"}],
            'threshold': {'line': {'color': "black", 'width': 4}, 'value': rop}}))
    st.plotly_chart(fig, use_container_width=True)
    st.write(f"โน๏ธ **ููุงุญุธุฉ:** ุฅุฐุง ุฑูุนุช 'ุชูููุฉ ุงูุดุญู'ุ ุณุชูุงุญุธ ุฃู ุงููุธุงู ูุทูุจ ููู ุฒูุงุฏุฉ ุงูู EOQ ูุชูููู ุนุฏุฏ ุงูุฑุญูุงุช.")

# --- 3. ุงูููุงุชูุฑ ูุงูุฑุจุญูุฉ (ุชุฃุซุฑ ุงูุชูู ูุงูุชูุงููู) ---
elif menu == "๐ ุงูููุงุชูุฑ ูุงูุฑุจุญูุฉ":
    st.header("๐ ุชุญููู ุงูุฑุจุญูุฉ ูุงูููุงุชูุฑ ุงูููููุฉ")
    df = st.session_state.db.copy()
    
    # ุญุณุงุจุงุช ุงูุฑุจุญ ุงููุนูุฏุฉ
    df['ุฅุฌูุงูู_ุงูุฅูุฑุงุฏ'] = df['ุงูุณุญุจ'] * df['ุงูุณุนุฑ']
    df['ุชูููุฉ_ุงูุจุถุงุนุฉ'] = df['ุงูุณุญุจ'] * df['ุงูุชูููุฉ']
    df['ุฎุณุงุฑุฉ_ุงูุชูู'] = df['ุฅุฌูุงูู_ุงูุฅูุฑุงุฏ'] * (df['ุงูุชูู_%'] / 100)
    df['ุตุงูู_ุงูุฑุจุญ'] = df['ุฅุฌูุงูู_ุงูุฅูุฑุงุฏ'] - df['ุชูููุฉ_ุงูุจุถุงุนุฉ'] - df['ุฎุณุงุฑุฉ_ุงูุชูู']
    
    st.subheader("ุงูููุฎุต ุงููุงูู ุงููููู")
    m1, m2, m3 = st.columns(3)
    m1.metric("ุตุงูู ุฃุฑุจุงุญ ุงูููู", f"{df['ุตุงูู_ุงูุฑุจุญ'].sum():,.2f} ุฑูุงู")
    m2.metric("ุฅุฌูุงูู ุฎุณุงุฆุฑ ุงูุชูู", f"-{df['ุฎุณุงุฑุฉ_ุงูุชูู'].sum():,.2f} ุฑูุงู", delta_color="inverse")
    m3.metric("ูุงูุด ุงูุฑุจุญ ุงูุชุดุบููู", f"{(df['ุตุงูู_ุงูุฑุจุญ'].sum()/df['ุฅุฌูุงูู_ุงูุฅูุฑุงุฏ'].sum()*100):.1f}%")
    
    st.table(df[['ุงูููุชุฌ', 'ุงูุณุญุจ', 'ุฅุฌูุงูู_ุงูุฅูุฑุงุฏ', 'ุฎุณุงุฑุฉ_ุงูุชูู', 'ุตุงูู_ุงูุฑุจุญ']])

# --- 4. ูุณุชุดุงุฑ AI ุงูุงุณุชุฑุงุชูุฌู (ูุตุงุฆุญ ุจูุงุกู ุนูู ุงูุชุบูุฑุงุช) ---
elif menu == "๐ก ูุณุชุดุงุฑ AI ุงูุงุณุชุฑุงุชูุฌู":
    st.header("๐ก ุชูุตูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุงุณุชุจุงููุฉ")
    df = st.session_state.db
    
    for _, row in df.iterrows():
        with st.expander(f"ุชุญููู ุงูููุชุฌ: {row['ุงูููุชุฌ']}"):
            # ูุตูุญุฉ ุจูุงุกู ุนูู ุงูุชูู
            if row['ุงูุชูู_%'] > 2:
                st.error(f"โ๏ธ **ูุดููุฉ ูุงูู:** ูุณุจุฉ ุงูุชูู ูู {row['ุงูููุชุฌ']} ูุฑุชูุนุฉ ({row['ุงูุชูู_%']}%). AI ููุตู ุจูุญุต ุธุฑูู ุงูุชุฎุฒูู ููุฑุงู ุฃู ุชุบููุฑ ุดุฑูุฉ ุงูููู.")
            
            # ูุตูุญุฉ ุจูุงุกู ุนูู ุงูุดุญู ูุงูุชุฎุฒูู (EOQ logic)
            eoq = calc_eoq(row['ุงูุณุญุจ'], row['ุงูุดุญู_S'], row['ุงูุชุฎุฒูู_H'])
            if row['ุงูุดุญู_S'] > row['ุงูุชุฎุฒูู_H'] * 50:
                st.warning(f"๐ **ูุตูุญุฉ ุงูุดุญู:** ุชูููุฉ ุงูุดุญู ูุฑุชูุนุฉ ุฌุฏุงู ููุงุฑูุฉ ุจุงูุชุฎุฒูู. ููุถู ุทูุจ ูููุงุช ุถุฎูุฉ ({int(eoq)} ูุทุนุฉ) ูุชูููู ุนุฏุฏ ูุฑุงุช ุงูุดุญู.")
            else:
                st.info(f"๐ **ูุตูุญุฉ ุงูุชุฏูู:** ุชูููุฉ ุงูุชุฎุฒูู ูุคุซุฑุฉุ ุญุงูู ุงูุญูุงุธ ุนูู ูุฎุฒูู 'ูุญูู' (Lean Inventory) ูุฒูุงุฏุฉ ุงูุณูููุฉ.")

            # ูุตูุญุฉ ุจูุงุกู ุนูู ุงูุณุญุจ ูุงูุฑุจุญ
            margin = (row['ุงูุณุนุฑ'] - row['ุงูุชูููุฉ']) / row['ุงูุณุนุฑ']
            if margin < 0.2:
                st.warning(f"๐ฐ **ุชูุจูู ุงูุฑุจุญูุฉ:** ูุงูุด ุงูุฑุจุญ ุถุฆูู ุฌุฏุงู. ุฃู ุฒูุงุฏุฉ ูู 'ุงูุชูู' ุณุชุญูู ูุฐุง ุงูููุชุฌ ูุฎุณุงุฑุฉ ูุญููุฉ.")
