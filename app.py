import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ
st.set_page_config(page_title="Ecotrak Market Intel", layout="wide", page_icon="๐")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ (ุฃุถููุง ุจูุงูุงุช ุงูููุงูุณูู)
if 'main_df' not in st.session_state:
    st.session_state.main_df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช ุตูุงุนูุฉ', 'ุงูุณุญุจ_ุงููููู': 15, 'ุงููุฎุฒูู': 65, 'ุงูุณุนุฑ': 12000, 'ุงูุชูููุฉ': 8500, 'S': 1500, 'H': 400, 'LT': 12, 'ุณุนุฑ_ุงูููุงูุณ': 12500},
        {'ุงูููุชุฌ': 'ูุณุชุดุนุฑุงุช ูุงูู', 'ุงูุณุญุจ_ุงููููู': 45, 'ุงููุฎุฒูู': 120, 'ุงูุณุนุฑ': 1200, 'ุงูุชูููุฉ': 700, 'S': 200, 'H': 30, 'LT': 5, 'ุณุนุฑ_ุงูููุงูุณ': 1150}
    ])

# --- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ---
st.sidebar.title("๐ Ecotrak Market Intelligence")
menu = st.sidebar.selectbox("ุงูุฃูุธูุฉ:", 
    ["๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช", "๐ ุงูุชูุฃู ุงูุฑููู ุงูุนููู", "๐งฌ ุฑุงุฏุงุฑ ุงูููุงูุณูู (Market Logic)", "๐ฑ ุงูุงุณุชุฏุงูุฉ"],
    key="nav_v9")

# --- ุงููุงุฆูุฉ 1: ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ูุญุฏุซุฉ) ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช":
    st.header("๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณูููุฉ")
    edited_df = st.data_editor(st.session_state.main_df, use_container_width=True, key="editor_v9")
    if st.button("๐พ ุญูุธ ุงูุจูุงูุงุช"):
        st.session_state.main_df = edited_df
        st.success("ุชู ุงูุชุฒุงูู ูุน ุงูุณูู!")
        st.rerun()

# --- ุงููุงุฆูุฉ ุงูุฌุฏูุฏุฉ: ุฑุงุฏุงุฑ ุงูููุงูุณูู (ุชุญููู ูุงูุนู ููุณุญุจ) ---
elif menu == "๐งฌ ุฑุงุฏุงุฑ ุงูููุงูุณูู (Market Logic)":
    st.header("๐งฌ ูุญุงูู ูุฑููุฉ ุงูุทูุจ ุงูุชูุงูุณูุฉ")
    df = st.session_state.main_df
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ููุฏุฑุงุณุฉ ุงูุชูุงูุณูุฉ:", df['ุงูููุชุฌ'].unique(), key="comp_sel")
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    col_input, col_chart = st.columns([1, 2])
    
    with col_input:
        st.subheader("๐๏ธ ูุชุบูุฑุงุช ุงูุณูู")
        comp_price = st.slider("ุณุนุฑ ุงูููุงูุณ ุงูุญุงูู (ุฑูุงู)", float(p['ุงูุณุนุฑ']*0.5), float(p['ุงูุณุนุฑ']*1.5), float(p['ุณุนุฑ_ุงูููุงูุณ']), key="comp_slider")
        your_price = st.number_input("ุณุนุฑู ุงูุญุงูู", value=float(p['ุงูุณุนุฑ']), key="your_p_input")
        
        # ุญุณุงุจ "ูุฌูุฉ ุงูุณุนุฑ" ูุฃุซุฑูุง ุนูู ุงูุณุญุจ ุงููููู (Price Sensitivity)
        # ูุงุนุฏุฉ: ุฅุฐุง ูุงู ุณุนุฑู ุฃุนูู ูู ุงูููุงูุณ ุจู 10%ุ ููู ุณุญุจู ุจูุณุจุฉ 15% ุชูุฑูุจุงู
        price_gap = (your_price / comp_price) - 1
        impact_factor = 1.5 # ูุนุงูู ุงูุญุณุงุณูุฉ
        projected_sales = max(0, p['ุงูุณุญุจ_ุงููููู'] * (1 - (price_gap * impact_factor)))
        
    with col_chart:
        st.subheader("๐ ุงูุชูุจุค ุจุงูุณุญุจ ุงููููู ุจูุงุกู ุนูู ุงูููุงูุณ")
        
        
        
        # ุฑุณู ุจูุงูู ููููุงุฑูุฉ
        fig_comp = go.Figure()
        fig_comp.add_trace(go.Bar(name='ุงูุณุญุจ ุงูุญุงูู', x=['ุงููุถุน ุงูุญุงูู'], y=[p['ุงูุณุญุจ_ุงููููู']], marker_color='blue'))
        fig_comp.add_trace(go.Bar(name='ุงูุณุญุจ ุงููุชููุน (ุจูุงุกู ุนูู ุงูููุงูุณ)', x=['ุชููุนุงุช ุงูุณูู'], y=[projected_sales], marker_color='orange'))
        st.plotly_chart(fig_comp, use_container_width=True)
    
    st.divider()
    st.subheader("๐ค ูุณุชุดุงุฑ ุงูุฐูุงุก ุงูุชูุงูุณู:")
    if your_price > comp_price:
        st.error(f"โ๏ธ ุณุนุฑู ุฃุนูู ูู ุงูููุงูุณ ุจู {price_gap*100:.1f}%. ุงูุชููุน: ุงูุฎูุงุถ ุงูุณุญุจ ุงููููู ุฅูู {projected_sales:.1f} ูุทุนุฉ.")
        st.write("๐ **ุงููุฑุงุฑ ุงูุฃูุถู:** ุฎูุถ ุงูุชูุงููู ุงูุชุดุบูููุฉ (H) ุฃู ุชูุฏูู ูููุฉ ูุถุงูุฉ ูุชุจุฑูุฑ ุงูุณุนุฑ.")
    else:
        st.success(f"โ ุณุนุฑู ุชูุงูุณู ุฌุฏุงู! ุฃูุช ุฃูู ูู ุงูููุงูุณ ุจู {abs(price_gap)*100:.1f}%.")
        st.write(f"๐ **ุงููุฑุงุฑ ุงูุฃูุถู:** ุงุฑูุน ูุฎุฒููู ููุฑุงูุ ูุฃู ุงูุณุญุจ ุณูุฑุชูุน ุฅูู {projected_sales:.1f} ูุทุนุฉ ููููุงู.")

# --- ุงููุงุฆูุฉ 2: ุงูุชูุฃู ุงูุฑููู (ุงูุชูุงุตูู ุงูุนูููุฉ) ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู ุงูุนููู":
    st.header("๐ ุงูุชูุฃู ุงูุฑููู: ุชุญููู ุงูุฃูุธูุฉ ูุงูุชุฏููุงุช")
    # (ููุง ูุถุน ููุฏ ุงูุชูุฃู ุงูุฑููู ุงูุณุงุจู ูุน ุฑุจุทู ุจุงูุณุญุจ "ุงููุชููุน" ุงูุฌุฏูุฏ)
    df = st.session_state.main_df
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูุตูู:", df['ุงูููุชุฌ'].unique(), key="twin_v9")
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    # ุญุณุงุจ EOQ ู ROP
    eoq = np.sqrt((2 * p['ุงูุณุญุจ_ุงููููู'] * 365 * p['S']) / p['H'])
    rop = p['ุงูุณุญุจ_ุงููููู'] * p['LT']
    
    
    
    c1, c2, c3 = st.columns(3)
    c1.metric("ุงููุฎุฒูู ุงูุญุงูู", f"{p['ุงููุฎุฒูู']} ูุทุนุฉ")
    c2.metric("ุฃูุงู ุงูุชุบุทูุฉ", f"{int(p['ุงููุฎุฒูู']/p['ุงูุณุญุจ_ุงููููู'])} ููู")
    c3.metric("ููุทุฉ ุงูุทูุจ (ROP)", f"{int(rop)} ูุญุฏุฉ")
