import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ (ูุฌุจ ุฃู ุชููู ุฃูู ุณุทุฑ ุจุฑูุฌู)
st.set_page_config(page_title="Ecotrak ERP Pro", layout="wide", page_icon="๐งพ")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ ูู ุงูุฐุงูุฑุฉ (Session State)
if 'db' not in st.session_state:
    st.session_state.db = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุตุงุจูู ูุงููุฏุฑ ุนุถูู', 'ุงูุณุญุจ': 45, 'ุงููุฎุฒูู': 300, 'ุงูุณุนุฑ': 25.0, 'ุงูุชูููุฉ': 12.0, 'S': 50, 'H': 2, 'LT': 3, 'ุงูุชูููู': 4.8},
        {'ุงูููุชุฌ': 'ููุธู ุฃูุงูู ููููู', 'ุงูุณุญุจ': 120, 'ุงููุฎุฒูู': 150, 'ุงูุณุนุฑ': 15.0, 'ุงูุชูููุฉ': 7.0, 'S': 30, 'H': 1, 'LT': 2, 'ุงูุชูููู': 4.2},
        {'ุงูููุชุฌ': 'ุดุงูุจู ุฃุทูุงู ูุงุนู', 'ุงูุณุญุจ': 15, 'ุงููุฎุฒูู': 50, 'ุงูุณุนุฑ': 45.0, 'ุงูุชูููุฉ': 22.0, 'S': 100, 'H': 5, 'LT': 7, 'ุงูุชูููู': 3.9}
    ])

# --- ุงููููู ุงูุฌุงูุจู ---
st.sidebar.title("๐ Ecotrak AI Core")
st.sidebar.markdown("---")
menu = st.sidebar.radio(
    "ุงูููุงุฆู ุงูุชูููุฐูุฉ:",
    ["๐ ุงูุชูุฃู ุงูุฑููู", "๐ ุงูููุงุชูุฑ ูุงููุจูุนุงุช", "๐ก ุฑุงุฏุงุฑ ุงูุฃูุซุฑ ุทูุจุงู", "๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช"],
    key="navigation"
)

# --- ุงููุธุงุฆู ุงููุณุงุนุฏุฉ ---
def get_data():
    return st.session_state.db

# --- 1. ุงููุงุฆูุฉ: ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ููุชุนุฏูู ูุงูุญูุธ) ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช":
    st.header("๐ ุฅุฏุงุฑุฉ ุฃุตูู ุงูููุดุฃุฉ")
    st.info("ูู ุจุชุนุฏูู ุงูุจูุงูุงุช ููุง ูุชุญุฏูุซ ูุงูู ุงููุธุงู ุชููุงุฆูุงู.")
    
    edited_df = st.data_editor(st.session_state.db, num_rows="dynamic", use_container_width=True, key="editor_v12")
    
    if st.button("๐พ ุญูุธ ุงูุชุบููุฑุงุช ููุฒุงููุฉ ุงูุจูุงูุงุช", key="save_btn"):
        st.session_state.db = edited_df
        st.success("ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ!")
        st.rerun()

# --- 2. ุงููุงุฆูุฉ: ุงูููุงุชูุฑ ูุงููุจูุนุงุช ุงูููููุฉ ---
elif menu == "๐ ุงูููุงุชูุฑ ูุงููุจูุนุงุช":
    st.header("๐ ููุธููุฉ ุงูููุงุชูุฑ ุงูุฐููุฉ")
    df = get_data()
    
    # ุญุณุงุจ ุงูููู ุงููุงููุฉ
    revenue = df['ุงูุณุญุจ'] * df['ุงูุณุนุฑ']
    profit = (df['ุงูุณุนุฑ'] - df['ุงูุชูููุฉ']) * df['ุงูุณุญุจ']
    
    col1, col2, col3 = st.columns(3)
    col1.metric("ุฅูุฑุงุฏุงุช ุงูููู", f"{revenue.sum():,.2f} ุฑูุงู")
    col2.metric("ุตุงูู ุงูุฑุจุญ", f"{profit.sum():,.2f} ุฑูุงู", delta="ุฅูุฌุงุจู")
    col3.metric("ุงููุทุน ุงููุจุงุนุฉ", f"{int(df['ุงูุณุญุจ'].sum())} ูุทุนุฉ")
    
    st.subheader("ุชูุงุตูู ููุงุชูุฑ ุงูุณุญุจ ุงููููู")
    bill_df = df[['ุงูููุชุฌ', 'ุงูุณุญุจ', 'ุงูุณุนุฑ']].copy()
    bill_df['ุงูุฅุฌูุงูู'] = bill_df['ุงูุณุญุจ'] * bill_df['ุงูุณุนุฑ']
    st.table(bill_df)

# --- 3. ุงููุงุฆูุฉ: ุงูุฃูุซุฑ ุทูุจุงู ููุตุงุฆุญ AI ---
elif menu == "๐ก ุฑุงุฏุงุฑ ุงูุฃูุซุฑ ุทูุจุงู":
    st.header("๐ก ุฑุงุฏุงุฑ ุงูููุชุฌุงุช ูุชุญููู ุณููู ุงูุนููุงุก")
    df = get_data()
    
    # ุฑุณู ุจูุงูู ููุฃูุซุฑ ุทูุจุงู
    fig = px.bar(df, x='ุงูููุชุฌ', y='ุงูุณุญุจ', color='ุงูุชูููู', 
                 title="ุชุญููู ุญุฌู ุงูุณุญุจ ุงููููู ููุงุจู ุชูููู ุงูุนููู",
                 color_continuous_scale=px.colors.sequential.Viridis)
    st.plotly_chart(fig, use_container_width=True)
    
    st.divider()
    st.subheader("๐ค ูุณุชุดุงุฑ AI ุงูุงุณุชุจุงูู")
    
    top_product = df.loc[df['ุงูุณุญุจ'].idxmax()]
    
    c1, c2 = st.columns(2)
    with c1:
        st.success(f"**ุงูููุชุฌ ุงูุจุทู:** {top_product['ุงูููุชุฌ']}")
        st.write("ุจูุงุกู ุนูู ุงูุชูุงุฑูุฑ ุงููุงูุนูุฉุ ูุฐุง ุงูููุชุฌ ููุซู 60% ูู ุชุฏููู ุงูููุฏู. ุชุฃูุฏ ูู ุชููุฑ ูุฎุฒูู ุฃูุงู (Safety Stock) ุฏุงุฆู ูู.")
    
    with c2:
        if any(df['ุงูุชูููู'] < 4.0):
            weak_p = df[df['ุงูุชูููู'] < 4.0].iloc[0]['ุงูููุชุฌ']
            st.warning(f"**ุชูุจูู ุฌูุฏุฉ:** ุงูููุชุฌ '{weak_p}'")
            st.write("ุงูุชูููู ููุฎูุถ (ุชุญุช 4.0). AI ููุตู ุจูุฑุงุฌุนุฉ ุชุนูููุงุช ุงูุนููุงุกุ ูุฏ ุชููู ููุงู ูุดููุฉ ูู ุงูุชุบููู ุฃู ุฌูุฏุฉ ุงูุชุตููุน.")

# --- 4. ุงููุงุฆูุฉ: ุงูุชูุฃู ุงูุฑููู (ุงูุชุญููู ุงูููุฌุณุชู) ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู":
    st.header("๐ ุงูุชูุฃู ุงูุฑููู ูููุงุกุฉ ุงููุฎุฒูู")
    df = get_data()
    
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ูููุญุงูุงุฉ:", df['ุงูููุชุฌ'].unique())
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    # ุญุณุงุจ EOQ ู ROP
    eoq = np.sqrt((2 * p['ุงูุณุญุจ'] * 365 * p['S']) / p['H'])
    rop = p['ุงูุณุญุจ'] * p['LT']
    
    col_a, col_b = st.columns(2)
    
    with col_a:
        fig_gauge = go.Figure(go.Indicator(
            mode = "gauge+number", value = p['ุงููุฎุฒูู'],
            title = {'text': f"ูุณุชูู ุงููุฎุฒูู ุงูุญุงูู ูู {sel_p}"},
            gauge = {
                'axis': {'range': [0, max(eoq, p['ุงููุฎุฒูู']*1.2)]},
                'steps': [{'range': [0, rop], 'color': "red"}],
                'threshold': {'line': {'color': "black", 'width': 4}, 'value': rop}}))
        st.plotly_chart(fig_gauge, use_container_width=True)

    with col_b:
        st.subheader("ุชุญููู ุงูุงุณุชุฏุงูุฉ ูุงูุทูุจ")
        st.write(f"**ูููุฉ ุงูุทูุจ ุงูุงูุชุตุงุฏู (EOQ):** {int(eoq)} ูุญุฏุฉ")
        st.write(f"**ููุทุฉ ุฅุนุงุฏุฉ ุงูุทูุจ:** {int(rop)} ูุญุฏุฉ")
        
        
        
        if p['ุงููุฎุฒูู'] <= rop:
            st.error("๐จ ุฎุทุฑ ููุงุฏ! ูุฌุจ ุทูุจ ูููุฉ ุฌุฏูุฏุฉ ููุฑุงู.")
        else:
            st.success("โ ุงููุฎุฒูู ูู ูุทุงู ุงูุฃูุงู.")
