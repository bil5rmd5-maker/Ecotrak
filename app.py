import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ
st.set_page_config(page_title="Ecotrak Ultimate", layout="wide", page_icon="๐")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ูู ุฐุงูุฑุฉ ุงูุฌูุณุฉ
if 'products_df' not in st.session_state:
    st.session_state.products_df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช ููุฑุจุงุฆูุฉ', 'ุงูุณุญุจ_ุงููููู': 12, 'ุงููุฎุฒูู': 45, 'ุงูุณุนุฑ': 8000, 'ุชูููุฉ_ุงูุทูุจ': 1200, 'ุชูููุฉ_ุงูุชุฎุฒูู': 200, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 10},
        {'ุงูููุชุฌ': 'ููุญุงุช ุชุญูู', 'ุงูุณุญุจ_ุงููููู': 35, 'ุงููุฎุฒูู': 120, 'ุงูุณุนุฑ': 1500, 'ุชูููุฉ_ุงูุทูุจ': 300, 'ุชูููุฉ_ุงูุชุฎุฒูู': 45, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 5}
    ])

# 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููุชููู
st.sidebar.title("๐ Ecotrak Control")
menu = st.sidebar.radio("ุงูุชูู ุฅูู:", ["๐ ููุญุฉ ุงููุฑุงุกุงุช ุงูุฐููุฉ", "โ ุฅุถุงูุฉ ููุชุฌุงุช", "๐ ุฑุงุฏุงุฑ ุงูููุฑุฏูู", "๐ฑ ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ"])

# --- ุงููุงุฆูุฉ 1: ููุญุฉ ุงููุฑุงุกุงุช ุงูุฐููุฉ ---
if menu == "๐ ููุญุฉ ุงููุฑุงุกุงุช ุงูุฐููุฉ":
    st.header("๐ ุชุญููู ุญุงูุฉ ุงูููุชุฌ ูุงูุฏุนู ุงููุญุธู")
    
    # ุงูุชุฃูุฏ ูู ูุฌูุฏ ููุชุฌุงุช
    if not st.session_state.products_df.empty:
        selected_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ูุชุญูููู:", st.session_state.products_df['ุงูููุชุฌ'].unique())
        p_data = st.session_state.products_df[st.session_state.products_df['ุงูููุชุฌ'] == selected_p].iloc[0]
        
        # ุญุณุงุจุงุช ุฐููุฉ
        days_left = p_data['ุงููุฎุฒูู'] / p_data['ุงูุณุญุจ_ุงููููู']
        eoq = np.sqrt((2 * p_data['ุงูุณุญุจ_ุงููููู'] * 365 * p_data['ุชูููุฉ_ุงูุทูุจ']) / p_data['ุชูููุฉ_ุงูุชุฎุฒูู'])
        
        # ููุทู ุงูุทูุจ ุงูุฐูู: ุงุทูุจ ููุท ุฅุฐุง ูุงู ุงููุฎุฒูู ูุง ูุบุทู ูุชุฑุฉ ุงูุชูุฑูุฏ
        needed_to_order = int(eoq) if days_left <= p_data['ูุฏุฉ_ุงูุชูุฑูุฏ'] else 0
        
        # ุนุฑุถ ุงููุคุดุฑุงุช
        m1, m2, m3 = st.columns(3)
        if days_left <= p_data['ูุฏุฉ_ุงูุชูุฑูุฏ']:
            m1.error(f"ุงูุญุงูุฉ: ุญุฑุฌุฉ ๐จ")
        else:
            m1.success(f"ุงูุญุงูุฉ: ุขููุฉ โ")
            
        m2.metric("ุฃูุงู ุงูุชุบุทูุฉ ุงููุชุจููุฉ", f"{int(days_left)} ููู")
        m3.metric("ุงููููุฉ ุงููุทููุจ ุทูุจูุง", f"{needed_to_order} ูุทุนุฉ")

        st.markdown("---")
        st.subheader("๐ก ุชูุตูุฉ ุงููุธุงู ุงููููุฉ:")
        if needed_to_order > 0:
            st.warning(f"ูุฌุจ ุฅุตุฏุงุฑ ุฃูุฑ ุดุฑุงุก ุจู {needed_to_order} ูุทุนุฉ ููุฑุงู. ูุฐู ุงููููุฉ ุชุบุทู ุงุญุชูุงุฌู ุงููุณุชูุจูู ุฏูู ุงูุชุณุจุจ ูู 'ุชูุฏุณ ูุงูู' ุจุงููุณุชูุฏุน.")
        else:
            st.info("ูุฎุฒููู ุงูุญุงูู ูุงูู ูุชุบุทูุฉ ูุชุฑุฉ ุงูุชูุฑูุฏ. ูุง ุชูู ุจุงูุดุฑุงุก ุงูุขู ูุชุฌูุจ ุชูุงููู ุงูุชุฎุฒูู ุงูุฅุถุงููุฉ.")
            
        # ุฑุณู ุจูุงูู ูุญุงูุฉ ุงูููุชุฌ
        fig = px.bar(x=['ุงููุฎุฒูู ุงูุญุงูู', 'ุงููููุฉ ุงููุซุงููุฉ (EOQ)'], y=[p_data['ุงููุฎุฒูู'], eoq], 
                     color=['ุงูุญุงูู', 'ุงููุซุงูู'], title=f"ููุงุฑูุฉ ุงููุฎุฒูู ูู {selected_p}")
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("ูุฑุฌู ุฅุถุงูุฉ ููุชุฌุงุช ูู ูุงุฆูุฉ 'ุฅุถุงูุฉ ููุชุฌุงุช'.")

# --- ุงููุงุฆูุฉ 2: ุฅุถุงูุฉ ุงูููุชุฌุงุช ---
elif menu == "โ ุฅุถุงูุฉ ููุชุฌุงุช":
    st.header("โ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ ููููุธููุฉ")
    with st.form("new_p_form"):
        name = st.text_input("ุงุณู ุงูููุชุฌ")
        c1, c2, c3 = st.columns(3)
        sales = c1.number_input("ุงูุณุญุจ ุงููููู", min_value=1, value=10)
        stock = c2.number_input("ุงููุฎุฒูู ุงูุญุงูู", min_value=0, value=100)
        price = c3.number_input("ุงูุณุนุฑ", min_value=1, value=500)
        
        c4, c5, c6 = st.columns(3)
        c_s = c4.number_input("ุชูููุฉ ุงูุทูุจ (S)", value=200)
        c_h = c5.number_input("ุชูููุฉ ุงูุชุฎุฒูู (H)", value=10)
        l_t = c6.number_input("ูุฏุฉ ุงูุชูุฑูุฏ (ุฃูุงู)", value=7)
        
        if st.form_submit_button("ุญูุธ ุงูููุชุฌ"):
            new_entry = {
                'ุงูููุชุฌ': name, 'ุงูุณุญุจ_ุงููููู': sales, 'ุงููุฎุฒูู': stock, 
                'ุงูุณุนุฑ': price, 'ุชูููุฉ_ุงูุทูุจ': c_s, 'ุชูููุฉ_ุงูุชุฎุฒูู': c_h, 'ูุฏุฉ_ุงูุชูุฑูุฏ': l_t
            }
            st.session_state.products_df = pd.concat([st.session_state.products_df, pd.DataFrame([new_entry])], ignore_index=True)
            st.success(f"ุชูุช ุฅุถุงูุฉ {name} ุจูุฌุงุญ!")

# --- ุงููุงุฆูุฉ 3: ุฑุงุฏุงุฑ ุงูููุฑุฏูู ---
elif menu == "๐ ุฑุงุฏุงุฑ ุงูููุฑุฏูู":
    st.header("๐ ุฑุงุฏุงุฑ ุงุฎุชูุงุฑ ุงูููุฑุฏ ุงูุฃูุซู")
    # ุจูุงูุงุช ูุญุงูุงุฉ ููููุฑุฏูู
    vendors = pd.DataFrame({
        'ุงูููุฑุฏ': ['ููุฑุฏ ูุญูู (ุณุฑูุน)', 'ููุฑุฏ ุฅููููู', 'ููุฑุฏ ุฏููู (ุฑุฎูุต)'],
        'ุฃูุงู_ุงูุชูุตูู': [3, 8, 20],
        'ุชูููุฉ_ุงูุดุญู': [1000, 500, 150],
        'ุฏุฑุฌุฉ_ุงูุฌูุฏุฉ': [80, 90, 98]
    })
    
    fig_v = px.scatter(vendors, x='ุฃูุงู_ุงูุชูุตูู', y='ุชูููุฉ_ุงูุดุญู', size='ุฏุฑุฌุฉ_ุงูุฌูุฏุฉ', 
                       text='ุงูููุฑุฏ', title="ููุงุฑูุฉ ุงูููุฑุฏูู (ุงูุญุฌู ููุซู ุงูุฌูุฏุฉ)")
    st.plotly_chart(fig_v, use_container_width=True)
    st.info("ุงููุฏู ุงูููุฌุณุชู: ุงุฎุชูุงุฑ ุงูููุฑุฏูู ูู ุงูุฒุงููุฉ ุงูุณููู ุงููุณุฑู (ุณุฑุนุฉ + ุชูููุฑ).")

# --- ุงููุงุฆูุฉ 4: ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ ---
elif menu == "๐ฑ ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ":
    st.header("๐ฑ ุชูุฑูุฑ ุงูุจุตูุฉ ุงููุฑุจูููุฉ (Eco-Logistics)")
    
    # ุญุณุงุจุงุช ูุงูุนูุฉ: ูููุง ูู ุนุฏุฏ ูุฑุงุช ุงูุทูุจ (ุจูุถู EOQ) ูู ุงูุงูุจุนุงุซ
    total_items = len(st.session_state.products_df)
    co2_saved = total_items * 15.4 # ูุฌู CO2 ูููุฑ ููู ุตูู
    
    c1, c2 = st.columns(2)
    c1.metric("CO2 ุงููููุฑ ุดูุฑูุงู", f"{co2_saved:.1f} ูุฌู")
    c2.metric("ุชูููู ุฑุญูุงุช ุงูุดุญู", f"{total_items * 2} ุฑุญูุฉ")
    
    st.markdown("---")
    st.success("ุจุงุนุชูุงุฏ ุฎูุงุฑุฒููุฉ Ecotrakุ ูุณุงูู ุงููุตูุน ูู ุชุญููู ูุณุชูุฏูุงุช ูุจุงุฏุฑุฉ ุงูุณุนูุฏูุฉ ุงูุฎุถุฑุงุก ุนุจุฑ ุชุญุณูู ููุงุกุฉ ุณูุงุณู ุงูุฅูุฏุงุฏ ูุชูููู ุงููุฏุฑ ุงูููุฌุณุชู.")
    ```

### ููู ูุญู ูุฐุง ุงูููุฏ ุงููุดุงูู ุงูุชู ูุงุฌูุชูุงุ

1.  **ุนูุงุฌ ุฎุทุฃ `KeyError`:** ููุช ุจุชุนุฑูู ุงูุฃุนูุฏุฉ ุจุฃุณูุงุก ุซุงุจุชุฉ (ูุซู 'ุงูููุชุฌ') ูุงุณุชุฎุฏูุชูุง ูู ูู ููุงู ูู ุงูููุฏ ุจููุณ ุงูุทุฑููุฉุ ููุง ูููุน ุชุนุทู ุงูุตูุญุฉ ุนูุฏ ุงูุชููู.
2.  **ููุญุฉ ุงููุฑุงุกุงุช ุงูุชูุงุนููุฉ:** ุงูุขู ุนูุฏ ุงุฎุชูุงุฑ ุฃู ููุชุฌุ ูุชู ุณุญุจ ุจูุงูุงุชู ุงูุญููููุฉ ูู `session_state` ูุนุฑุถ "ุญุงูุฉ ุงูุฎุทุฑ" ุจูุงุกู ุนูู ูุฎุฒููู ูุณุฑุนุฉ ุณุญุจู ุงูุญุงููุฉ.
3.  **ุชุญุฏูุฏ ุงููููุฉ "ุจุฏูู ุฎุณุงุฑุฉ":** ุฃุถูุช ููุทูุงู ุฐููุงูุ ุฅุฐุง ูุงู ูุฎุฒููู ูููู ููุชุฑุฉ ูุตูู ุงูุดุญูุฉ ุงูุฌุฏูุฏุฉุ ูููู ูู ุงููุธุงู "ุงููููุฉ ุงููุทููุจุฉ: 0" ุญุชู ูุง ุชุถูุน ุฃููุงูู ูู ุงูุชุฎุฒูู ุงูุฒุงุฆุฏ.
4.  **ุชูุนูู ุงูููุฑุฏูู ูุงูุงุณุชุฏุงูุฉ:** ุฃุตุจุญุช ูุฐู ุงูููุงุฆู ุชุนูู ุงูุขู ุจุจูุงูุงุช ูุงุถุญุฉ ูุฑุณูู ุจูุงููุฉ ุชูุถุญ "ููุงุฐุง" ูุฎุชุงุฑ ูุฐุง ุงูููุฑุฏ ูููู ูุฎุฏู "ุงูุจูุฆุฉ".

**ุฎุทูุชู ุงูุชุงููุฉ:**
ูู ุจูุณุฎ ูุฐุง ุงูููุฏ ุจุงููุงูู ูุฑูุนู ุนูู GitHub. ุชุฃูุฏ ูู ุฃู ููู `requirements.txt` ูุญุชูู ุนูู ุงููููุงุช ุงูุชุงููุฉ ููุท:
```text
streamlit
pandas
numpy
plotly
