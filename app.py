import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ
st.set_page_config(page_title="Ecotrak Ultimate", layout="wide", page_icon="๐")

# 2. ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ูู ุฐุงูุฑุฉ ุงูุฌูุณุฉ (ูุถูุงู ุงูุณูุงุณุฉ)
if 'products_df' not in st.session_state:
    st.session_state.products_df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช ููุฑุจุงุฆูุฉ', 'ุงูุณุญุจ_ุงููููู': 12, 'ุงููุฎุฒูู': 45, 'ุงูุณุนุฑ': 8000, 'ุชูููุฉ_ุงูุทูุจ': 1200, 'ุชูููุฉ_ุงูุชุฎุฒูู': 200, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 10},
        {'ุงูููุชุฌ': 'ููุญุงุช ุชุญูู', 'ุงูุณุญุจ_ุงููููู': 35, 'ุงููุฎุฒูู': 120, 'ุงูุณุนุฑ': 1500, 'ุชูููุฉ_ุงูุทูุจ': 300, 'ุชูููุฉ_ุงูุชุฎุฒูู': 45, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 5}
    ])

# 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููุชููู
st.sidebar.title("๐ Ecotrak Control")
menu = st.sidebar.radio("ุงูุชูู ุฅูู:", ["๐ ููุญุฉ ุงููุฑุงุกุงุช ุงูุฐููุฉ", "โ ุฅุถุงูุฉ ููุชุฌุงุช", "๐ ุฑุงุฏุงุฑ ุงูููุฑุฏูู", "๐ฑ ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ"])

# --- ุงููุงุฆูุฉ 1: ููุญุฉ ุงููุฑุงุกุงุช ุงูุฐููุฉ (ุชู ุชุญุฏูุซูุง ูุชููู ุชูุงุนููุฉ ููู ููุชุฌ) ---
if menu == "๐ ููุญุฉ ุงููุฑุงุกุงุช ุงูุฐููุฉ":
    st.header("๐ ุชุญููู ุญุงูุฉ ุงูููุชุฌ ูุงูุฏุนู ุงููุญุธู")
    
    # ุงุฎุชูุงุฑ ุงูููุชุฌ ููุดุงูุฏุฉ ุญุงูุชู
    selected_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ูุชุญูููู:", st.session_state.products_df['ุงูููุชุฌ'])
    p_data = st.session_state.products_df[st.session_state.products_df['ุงูููุชุฌ'] == selected_p].iloc[0]
    
    # ุญุณุงุจุงุช ุฐููุฉ
    days_left = p_data['ุงููุฎุฒูู'] / p_data['ุงูุณุญุจ_ุงููููู']
    reorder_point = p_data['ุงูุณุญุจ_ุงููููู'] * p_data['ูุฏุฉ_ุงูุชูุฑูุฏ'] # ููุทุฉ ุฅุนุงุฏุฉ ุงูุทูุจ
    eoq = np.sqrt((2 * p_data['ุงูุณุญุจ_ุงููููู'] * 365 * p_data['ุชูููุฉ_ุงูุทูุจ']) / p_data['ุชูููุฉ_ุงูุชุฎุฒูู'])
    
    # ุนุฑุถ ุงููุคุดุฑุงุช ุจุงูุฃููุงู
    m1, m2, m3 = st.columns(3)
    
    # ุญุงูุฉ ุงูููุชุฌ (ุฎุทุฑุฉ ุฃู ุขููุฉ)
    if days_left <= p_data['ูุฏุฉ_ุงูุชูุฑูุฏ']:
        m1.error(f"ุงูุญุงูุฉ: ุฎุทุฑุฉ (ููุงุฏ ูุดูู)")
    else:
        m1.success(f"ุงูุญุงูุฉ: ุขููุฉ")
        
    m2.metric("ุฃูุงู ุงูุชุบุทูุฉ ุงููุชุจููุฉ", f"{int(days_left)} ููู")
    
    # ุงููููุฉ ุงููุทููุจุฉ ุจุฏูุฉ (ุชุบุทู ุงูุงุญุชูุงุฌ ููุง ุชุฒูุฏ ุงูุชุฎุฒูู)
    needed_to_order = int(eoq) if days_left <= p_data['ูุฏุฉ_ุงูุชูุฑูุฏ'] else 0
    m3.metric("ุงููููุฉ ุงููุทููุจุฉ ููุฑุงู", f"{needed_to_order} ูุทุนุฉ")

    st.markdown("---")
    st.subheader("๐ก ูุตูุญุฉ ุงููุณุชุดุงุฑ ุงูุฐูู:")
    if needed_to_order > 0:
        st.warning(f"ูุฌุจ ุทูุจ {needed_to_order} ูุทุนุฉ ุงูุขู. ูุฐู ุงููููุฉ ุชู ุญุณุงุจูุง ุจูุงุกู ุนูู ูุนุงุฏูุฉ EOQ ูุชูุงุฒู ุจูู ุณุฑุนุฉ ุงูุณุญุจ ูุชูููุฉ ุงูุชุฎุฒูู.")
    else:
        st.info("ูุง ุญุงุฌุฉ ููุทูุจ ุญุงููุงูุ ูุฎุฒููู ูุบุทู ูุชุฑุฉ ุงูุชูุฑูุฏ ุจุณูุงู.")

# --- ุงููุงุฆูุฉ 2: ุฅุถุงูุฉ ุงูููุชุฌุงุช ---
elif menu == "โ ุฅุถุงูุฉ ููุชุฌุงุช":
    st.header("โ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ ููููุธููุฉ")
    with st.form("new_p"):
        name = st.text_input("ุงุณู ุงูููุชุฌ")
        c1, c2, c3 = st.columns(3)
        sales = c1.number_input("ุงูุณุญุจ ุงููููู", value=10)
        stock = c2.number_input("ุงููุฎุฒูู ุงูุญุงูู", value=100)
        price = c3.number_input("ุงูุณุนุฑ", value=500)
        if st.form_submit_button("ุญูุธ ุงูููุชุฌ"):
            new_data = {'ุงูููุชุฌ': name, 'ุงูุณุญุจ_ุงููููู': sales, 'ุงููุฎุฒูู': stock, 'ุงูุณุนุฑ': price, 'ุชูููุฉ_ุงูุทูุจ': 200, 'ุชูููุฉ_ุงูุชุฎุฒูู': 10, 'ูุฏุฉ_ุงูุชูุฑูุฏ': 7}
            st.session_state.products_df = pd.concat([st.session_state.products_df, pd.DataFrame([new_data])], ignore_index=True)
            st.success("ุชู ุงูุชุญุฏูุซ!")

# --- ุงููุงุฆูุฉ 3: ุฑุงุฏุงุฑ ุงูููุฑุฏูู (ุชุนูู ุงูุขู) ---
elif menu == "๐ ุฑุงุฏุงุฑ ุงูููุฑุฏูู":
    st.header("๐ ููุงุฑูุฉ ูุชูููู ุงูููุฑุฏูู")
    v_data = pd.DataFrame({
        'ุงูููุฑุฏ': ['ุงูููุฑุฏ ุงููุญูู', 'ุงูููุฑุฏ ุงูุฅููููู', 'ุงูููุฑุฏ ุงูุฏููู'],
        'ูุฏุฉ_ุงูุชูุตูู': [3, 7, 15],
        'ุงูุชูููุฉ_ุงูุฅุถุงููุฉ': [500, 300, 100],
        'ุงูุฌูุฏุฉ': [85, 90, 95]
    })
    
    fig_v = px.scatter(v_data, x='ูุฏุฉ_ุงูุชูุตูู', y='ุงูุชูููุฉ_ุงูุฅุถุงููุฉ', size='ุงูุฌูุฏุฉ', text='ุงูููุฑุฏ', title="ุฑุงุฏุงุฑ ุงุฎุชูุงุฑ ุงูููุฑุฏ ุงูุฃูุณุจ")
    st.plotly_chart(fig_v, use_container_width=True)
    st.write("๐ก ุงูููุฑุฏ ุงูุฃูุฑุจ ูุฃุณูู ุงููุณุงุฑ ูู ุงูุฃุณุฑุน ูุงูุฃุฑุฎุต.")

# --- ุงููุงุฆูุฉ 4: ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ (ุชุนูู ุงูุขู) ---
elif menu == "๐ฑ ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ":
    st.header("๐ฑ ุชูุฑูุฑ ุงูุฃุซุฑ ุงูุจูุฆู (Green Logistics)")
    total_shipping = len(st.session_state.products_df) * 12 # ุงูุชุฑุงุถ ุดุญูุฉ ุดูุฑูุงู ููู ููุชุฌ
    co2_saved = total_shipping * 5.5 # ูุฌู Co2 ูููุฑ ุจูุถู ุชูููู ุนุฏุฏ ุงูุดุญูุงุช
    
    c1, c2 = st.columns(2)
    c1.metric("ุงูุจุนุงุซุงุช CO2 ุงููููุฑุฉ ุดูุฑูุงู", f"{co2_saved:.1f} ูุฌู")
    c2.metric("ููุงุกุฉ ุงูููู ุงูุฎุถุฑุงุก", "88%")
    
    st.bar_chart(np.random.randn(10, 1)) # ุฑุณู ุชุฎููู ููุฃุซุฑ
    st.success("ูุดุฑูุนู ูุณุงูู ูู ุชูููู ุนุฏุฏ ุงูุดุญูุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ ุจูุณุจุฉ 22%ุ ููุง ูุฏุนู ูุจุงุฏุฑุฉ ุงูุณุนูุฏูุฉ ุงูุฎุถุฑุงุก.")
