import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©
st.set_page_config(page_title="Ecotrak Smart ERP", layout="wide", page_icon="ðŸ§¾")

# 2. ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© (Ø£Ø¶ÙÙ†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ)
if 'db' not in st.session_state:
    st.session_state.db = pd.DataFrame([
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'ØµØ§Ø¨ÙˆÙ† Ø¹Ø¶ÙˆÙŠ - Ù„Ø§ÙÙ†Ø¯Ø±', 'Ø§Ù„Ø³Ø­Ø¨': 45, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 300, 'Ø§Ù„Ø³Ø¹Ø±': 25, 'Ø§Ù„ØªÙƒÙ„ÙØ©': 12, 'S': 50, 'H': 2, 'LT': 3, 'ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡': 4.8},
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'Ù…Ù†Ø¸Ù Ø£ÙˆØ§Ù†ÙŠ - Ù„ÙŠÙ…ÙˆÙ†', 'Ø§Ù„Ø³Ø­Ø¨': 120, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 150, 'Ø§Ù„Ø³Ø¹Ø±': 15, 'Ø§Ù„ØªÙƒÙ„ÙØ©': 7, 'S': 30, 'H': 1, 'LT': 2, 'ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡': 4.2},
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'Ø´Ø§Ù…Ø¨Ùˆ Ø£Ø·ÙØ§Ù„', 'Ø§Ù„Ø³Ø­Ø¨': 15, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 50, 'Ø§Ù„Ø³Ø¹Ø±': 45, 'Ø§Ù„ØªÙƒÙ„ÙØ©': 22, 'S': 100, 'H': 5, 'LT': 7, 'ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡': 3.9}
    ])

# --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« ---
with st.sidebar:
    st.title("ðŸ§¾ Ecotrak Intelligent ERP")
    menu = st.radio("Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:", 
        ["ðŸŒ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ", 
         "ðŸ“‘ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¢Ù„ÙŠØ©", 
         "ðŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ & AI", 
         "ðŸŽ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ", 
         "ðŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„"], key="nav_v11")
    st.divider()
    st.write(f"ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d')}")

# --- 1. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ) ---
if menu == "ðŸ“‘ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¢Ù„ÙŠØ©":
    st.header("ðŸ“‘ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ")
    df = st.session_state.db
    
    # Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
    df['Ø¥ÙŠØ±Ø§Ø¯_ÙŠÙˆÙ…ÙŠ'] = df['Ø§Ù„Ø³Ø­Ø¨'] * df['Ø§Ù„Ø³Ø¹Ø±']
    df['ØªÙ„Ù_Ù…ØªÙˆÙ‚Ø¹'] = df['Ø¥ÙŠØ±Ø§Ø¯_ÙŠÙˆÙ…ÙŠ'] * 0.02 # Ø§ÙØªØ±Ø§Ø¶ 2% Ù‡Ø§Ù„Ùƒ
    df['ØµØ§ÙÙŠ_Ø±Ø¨Ø­_ÙŠÙˆÙ…ÙŠ'] = (df['Ø§Ù„Ø³Ø­Ø¨'] * (df['Ø§Ù„Ø³Ø¹Ø±'] - df['Ø§Ù„ØªÙƒÙ„ÙØ©'])) - df['ØªÙ„Ù_Ù…ØªÙˆÙ‚Ø¹']
    
    st.subheader("Ù…Ù„Ø®Øµ ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…")
    c1, c2, c3 = st.columns(3)
    c1.metric("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", f"{df['Ø¥ÙŠØ±Ø§Ø¯_ÙŠÙˆÙ…ÙŠ'].sum():,} Ø±ÙŠØ§Ù„")
    c2.metric("ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ", f"{df['ØµØ§ÙÙŠ_Ø±Ø¨Ø­_ÙŠÙˆÙ…ÙŠ'].sum():.2f} Ø±ÙŠØ§Ù„", delta="12%+")
    c3.metric("Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©", f"{df['Ø§Ù„Ø³Ø­Ø¨'].sum()} Ù‚Ø·Ø¹Ø©")
    
    st.table(df[['Ø§Ù„Ù…Ù†ØªØ¬', 'Ø§Ù„Ø³Ø­Ø¨', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø¥ÙŠØ±Ø§Ø¯_ÙŠÙˆÙ…ÙŠ', 'ØµØ§ÙÙŠ_Ø±Ø¨Ø­_ÙŠÙˆÙ…ÙŠ']])
    
    if st.button("ðŸ–¨ï¸ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ"):
        st.success("ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©.")

# --- 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ ÙˆÙ†ØµØ§Ø¦Ø­ AI (Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ) ---
elif menu == "ðŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ & AI":
    st.header("ðŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ ÙˆØ±Ø¤Ù‰ AI")
    df = st.session_state.db
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¨Ø·Ù„ (Ø§Ù„Ø£ÙƒØ«Ø± Ø³Ø­Ø¨Ø§Ù‹)
    best_seller = df.loc[df['Ø§Ù„Ø³Ø­Ø¨'].idxmax()]
    
    col_a, col_b = st.columns([2, 1])
    
    with col_a:
        st.subheader("ðŸ“Š ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª")
        fig_demand = px.bar(df, x='Ø§Ù„Ù…Ù†ØªØ¬', y='Ø§Ù„Ø³Ø­Ø¨', color='ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 
                           title="ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† Ø­ÙŠØ« Ø¥Ù‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ†",
                           labels={'Ø§Ù„Ø³Ø­Ø¨': 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹'})
        st.plotly_chart(fig_demand, use_container_width=True)
        
    with col_b:
        st.subheader("ðŸ¤– Ù†ØµÙŠØ­Ø© AI Ø§Ù„Ø§Ø³ØªØ¨Ø§Ù‚ÙŠØ©")
        st.markdown(f"**Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹:** {best_seller['Ø§Ù„Ù…Ù†ØªØ¬']}")
        
        # Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©
        if best_seller['Ø§Ù„Ø³Ø­Ø¨'] > 100:
            st.info(f"ðŸ’¡ **Ù†ØµÙŠØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±Ùƒ:** Ø¨Ù…Ø§ Ø£Ù† '{best_seller['Ø§Ù„Ù…Ù†ØªØ¬']}' Ø¹Ù„ÙŠÙ‡ Ø·Ù„Ø¨ Ù‡Ø§Ø¦Ù„ØŒ Ù†ÙˆØµÙŠ Ø¨ÙˆØ¶Ø¹Ù‡ Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù†ØªØ¬Ø§Øª Ø£Ù‚Ù„ Ø³Ø­Ø¨Ø§Ù‹ Ù„Ø²ÙŠØ§Ø¯Ø© Ù…Ø¨ÙŠØ¹Ø§ØªÙ‡Ø§ (Cross-selling).")
        
        if any(df['ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'] < 4.0):
            low_rate_p = df[df['ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'] < 4.0].iloc[0]['Ø§Ù„Ù…Ù†ØªØ¬']
            st.warning(f"âš ï¸ **Ù†ØµÙŠØ­Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©:** Ø§Ù„Ù…Ù†ØªØ¬ '{low_rate_p}' Ù„Ø¯ÙŠÙ‡ ØªÙ‚ÙŠÙŠÙ… Ù…Ù†Ø®ÙØ¶. Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© ÙˆØ¬ÙˆØ¯ Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„ØªØºÙ„ÙŠÙ Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±.")

    st.divider()
    st.subheader("ðŸ§  Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Market Trends)")
    st.write("Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ù…Ù†Ø¸ÙØ§Øª ÙˆØ§Ù„ØµØ§Ø¨ÙˆÙ†:")
    st.markdown("""
    - **Ù†Ù…Ø· Ø§Ù„Ø´Ø±Ø§Ø¡:** ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø¨ÙˆØ§Øª Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±.
    - **ØªÙˆØµÙŠØ© AI:** Ù‚Ù… Ø¨Ø²ÙŠØ§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ† 'ØµØ§Ø¨ÙˆÙ† Ø§Ù„Ù„Ø§ÙÙ†Ø¯Ø±' Ø¨Ù†Ø³Ø¨Ø© 20% ÙÙŠ Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.
    - **ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ´Ù„:** Ø£ÙŠ Ù…Ù†ØªØ¬ ÙŠÙ‚Ù„ ØªÙ‚ÙŠÙŠÙ…Ù‡ Ø¹Ù† 3.5 ÙŠØ¬Ø¨ Ø¥ÙŠÙ‚Ø§Ù Ø·Ù„Ø¨Ù‡ ÙÙˆØ±Ø§Ù‹ ÙˆØªØµÙÙŠØªÙ‡.
    """)

# --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø§Ù„ØªÙˆØ£Ù…ØŒ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØŒ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) ØªØ¸Ù„ ØªØ¹Ù…Ù„ Ø¨ÙƒØ§Ù…Ù„ ÙƒÙØ§Ø¡ØªÙ‡Ø§ ---
elif menu == "ðŸŒ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ":
    st.header("ðŸŒ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†")
    # (ÙƒÙˆØ¯ Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ù‡)

elif menu == "ðŸŽ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ":
    st.header("ðŸŽ¯ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†")
    # (ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚)

elif menu == "ðŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„":
    st.header("ðŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©")
    edited_df = st.data_editor(st.session_state.db, use_container_width=True, key="editor_v11")
    if st.button("ðŸ’¾ Ø­ÙØ¸"):
        st.session_state.db = edited_df
        st.rerun()
