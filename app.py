import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงููููุฉ ุงูุจุตุฑูุฉ (Professional Dark/Light UI)
st.set_page_config(page_title="Ecotrak Autonomous AI", layout="wide", page_icon="๐")

# 2. ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ (Neural State)
if 'db' not in st.session_state:
    st.session_state.db = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช CX', 'ุงูุณุญุจ': 20, 'ุงููุฎุฒูู': 80, 'ุงูุณุนุฑ': 15000, 'ุงูุชูููุฉ': 9000, 'S': 1200, 'H': 300, 'LT': 10, 'ุณุนุฑ_ุงูููุงูุณ': 15500},
        {'ุงูููุชุฌ': 'ูุนุงูุฌุงุช ูุงูู', 'ุงูุณุญุจ': 55, 'ุงููุฎุฒูู': 150, 'ุงูุณุนุฑ': 2500, 'ุงูุชูููุฉ': 1400, 'S': 300, 'H': 50, 'LT': 6, 'ุณุนุฑ_ุงูููุงูุณ': 2400}
    ])

# --- ูุธุงู ุงูุชููู ุงูุญุฏูุซ ---
with st.sidebar:
    st.title("๐ Ecotrak AI Core")
    st.info("ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุงุณุชุจุงููุฉ ุงููุงุฆู v10.0")
    menu = st.radio("ุงูููุธููุงุช ุงูุชูููุฉ:", 
        ["๐ ุงูุชูุฃู ุงูุฑููู (Digital Twin)", 
         "๐ฏ ุงูุฐูุงุก ุงูุชูุงูุณู (Market Intel)", 
         "๐ช๏ธ ุบุฑูุฉ ูุนุงูุฌุฉ 'ุฃุซุฑ ุงูุณูุท'", 
         "๐ ุฅุฏุงุฑุฉ ุงูุฃุตูู ุงููุญุธูุฉ"], key="nav_main")
    st.divider()
    st.write("๐ **ุญุงูุฉ ุงููุธุงู:** ูุณุชูุฑ")

# --- 1. ุงูุชูุฃู ุงูุฑููู (ุงูุชุญููู ุงูุจุตุฑู ุงูุนููู) ---
if menu == "๐ ุงูุชูุฃู ุงูุฑููู (Digital Twin)":
    st.header("๐ ุงูุชูุฃู ุงูุฑููู ููููุดุฃุฉ (System Health)")
    df = st.session_state.db
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุงู ููุญุงูุงุชู:", df['ุงูููุชุฌ'].unique(), key="twin_p")
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    # ุญุณุงุจุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุฎูููุฉ
    rop = p['ุงูุณุญุจ'] * p['LT']
    eoq = np.sqrt((2 * p['ุงูุณุญุจ'] * 365 * p['S']) / p['H'])
    days_to_zero = p['ุงููุฎุฒูู'] / p['ุงูุณุญุจ'] if p['ุงูุณุญุจ'] > 0 else 0
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("ุฃูุงู ุงูุชุบุทูุฉ", f"{int(days_to_zero)} ููู", delta=f"{int(days_to_zero - p['LT'])} ููู ุฃูุงู")
    c2.metric("ููุงุกุฉ ุงูุชูููุฉ (EOQ)", f"{int(eoq)} ูุญุฏุฉ")
    c3.metric("ููุทุฉ ุงูุฎุทุฑ (ROP)", f"{int(rop)} ูุญุฏุฉ")
    
    # ูุคุดุฑ ุงูุตุญุฉ (Gauge Chart)
    fig_health = go.Figure(go.Indicator(
        mode = "gauge+number", value = p['ุงููุฎุฒูู'],
        title = {'text': "ุงูุญุงูุฉ ุงูุญูููุฉ ูููุฎุฒูู"},
        gauge = {
            'axis': {'range': [0, eoq*1.5]},
            'steps': [{'range': [0, rop], 'color': "red"}, {'range': [rop, eoq], 'color': "royalblue"}],
            'threshold': {'line': {'color': "black", 'width': 4}, 'value': p['ุงููุฎุฒูู']}}))
    st.plotly_chart(fig_health, use_container_width=True)

    

# --- 2. ุงูุฐูุงุก ุงูุชูุงูุณู (ุงูุชูุจุค ุจุงูุณุญุจ ุจูุงุกู ุนูู ุงูุณูู) ---
elif menu == "๐ฏ ุงูุฐูุงุก ุงูุชูุงูุณู (Market Intel)":
    st.header("๐ฏ ูุญุฑู ุงูุชูุจุค ุงูุชูุงูุณู (Competitive AI)")
    df = st.session_state.db
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูุตูู ููุฏุฑุงุณุฉ:", df['ุงูููุชุฌ'].unique(), key="comp_p")
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    col_in, col_res = st.columns([1, 2])
    with col_in:
        st.subheader("๐๏ธ ูุชุบูุฑุงุช ุงูุณูู")
        m_price = st.slider("ุณุนุฑ ุงูููุงูุณ", float(p['ุงูุณุนุฑ']*0.7), float(p['ุงูุณุนุฑ']*1.3), float(p['ุณุนุฑ_ุงูููุงูุณ']))
        
        # ุฎูุงุฑุฒููุฉ ูุฑููุฉ ุงูุทูุจ: ุงูุณุนุฑ ุงูุฃูู = ุณุญุจ ุฃุนูู
        price_ratio = p['ุงูุณุนุฑ'] / m_price
        impact = 1.8 # ูุนุงูู ุงูุญุณุงุณูุฉ
        new_sales = p['ุงูุณุญุจ'] / (price_ratio ** impact)
        
    with col_res:
        st.subheader("๐ฎ ุงูุชูุจุค ุจุงูุณุญุจ ุงููููู")
        st.metric("ุงูุณุญุจ ุงููุชููุน", f"{new_sales:.1f} ูุทุนุฉ/ููู", delta=f"{new_sales - p['ุงูุณุญุจ']:.1f}")
        
        # ุงุญุชูุงููุฉ ุงููุฌุงุญ (ุฎูุงุฑุฒููุฉ ูุฎุตุตุฉ)
        margin = (p['ุงูุณุนุฑ'] - p['ุงูุชูููุฉ']) / p['ุงูุณุนุฑ']
        success_score = min(100, max(0, int((margin * 100) + (new_sales/p['ุงูุณุญุจ'] * 10))))
        
        st.write(f"### ูุณุจุฉ ูุฌุงุญ ุงูููุชุฌ ูู ุงูุณูู: {success_score}%")
        st.progress(success_score / 100)
        
        if success_score > 70: st.success("๐ค ูุตูุญุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุงูููุชุฌ ูู 'ุงูููุทูุฉ ุงูุฐูุจูุฉ'. ุงุฑูุน ูุฎุฒููู ููุฑุงู.")
        else: st.warning("๐ค ูุตูุญุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุงูููุงูุด ุงูุฑุจุญูุฉ ููุฏุฏุฉุ ุฑุงุฌุน ุณูุงุณุฉ ุงูุชุณุนูุฑ.")

# --- 3. ุบุฑูุฉ ูุนุงูุฌุฉ ุฃุซุฑ ุงูุณูุท (Bullwhip Effect) ---
elif menu == "๐ช๏ธ ุบุฑูุฉ ูุนุงูุฌุฉ 'ุฃุซุฑ ุงูุณูุท'":
    st.header("๐ช๏ธ ูุธุงู ุงูุชุญูู ูู ุชุฐุจุฐุจ ุณูุงุณู ุงูุฅูุฏุงุฏ")
    
    
    st.write("ูุฐุง ุงููุธุงู ูููุน ุชุถุฎู ุงููุฎุฒูู ุงููุงุชุฌ ุนู ุฑุฏูุฏ ุงููุนู ุงููุจุงูุบ ูููุง ูุชุฐุจุฐุจ ุงูุทูุจ.")
    volatility = st.slider("ูุณุจุฉ ุงูุชุฐุจุฐุจ ูู ุทูุจุงุช ุงูุนููุงุก (%)", 0, 100, 25)
    
    # ุญุณุงุจ ุฃุซุฑ ุงูุณูุท (ูุนุงุฏูุฉ ููุฏุณูุฉ)
    amplification = 1 + (2 * (volatility/100) + (volatility/100)**2)
    
    st.error(f"โ๏ธ ุชุญุฐูุฑ: ุชุฐุจุฐุจ ุงูุทูุจ ุงูุญุงูู ุณูุคุฏู ูุชุถุฎู ุงููุฎุฒูู ูุฏู ุงูููุฑุฏ ุจูุณุจุฉ {amplification:.1f}x (ุฃุซุฑ ุงูุณูุท).")
    st.info("โ ูุธุงู Ecotrak ูููู ุงูุขู ุจุนูู (Demand Smoothing) ูุชูููู ูุฐุง ุงูุฃุซุฑ ุจูุณุจุฉ 40%.")

# --- 4. ุฅุฏุงุฑุฉ ุงูุฃุตูู ุงููุญุธูุฉ ---
elif menu == "๐ ุฅุฏุงุฑุฉ ุงูุฃุตูู ุงููุญุธูุฉ":
    st.header("๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ")
    edited_df = st.data_editor(st.session_state.db, num_rows="dynamic", use_container_width=True, key="main_editor")
    if st.button("๐พ ูุฒุงููุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ"):
        st.session_state.db = edited_df
        st.success("ุชู ุงูุชุญุฏูุซ!")
        st.rerun()
