import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
st.set_page_config(page_title="Ecotrak Neural ERP - Pro Edition", layout="wide", page_icon="ğŸ†")

# 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©
if 'df' not in st.session_state:
    st.session_state.df = pd.DataFrame([
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'Ù…Ø­Ø±ÙƒØ§Øª ØªÙˆØ±Ø¨ÙŠÙ†ÙŠØ©', 'Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ': 12, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 45, 'Ø§Ù„Ø³Ø¹Ø±': 8000, 'S': 1200, 'H': 200, 'LT': 10},
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'ÙˆØ­Ø¯Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ': 35, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 120, 'Ø§Ù„Ø³Ø¹Ø±': 1500, 'S': 300, 'H': 45, 'LT': 5},
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª Ù„ÙŠØ²Ø±', 'Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ': 50, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 300, 'Ø§Ù„Ø³Ø¹Ø±': 450, 'S': 100, 'H': 15, 'LT': 3}
    ])

# 3. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
st.sidebar.title("ğŸ† Ecotrak Pro AI")
menu = st.sidebar.radio("Ø§Ù„Ø£Ù†Ø¸Ù…Ø©:", ["ğŸ“‹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "ğŸ“Š Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ", "ğŸ”¬ Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ (Stress Test)", "ğŸšš Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", "ğŸŒ± Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©"])

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ ØªØµÙ†ÙŠÙ ABC Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
if menu == "ğŸ“‹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª":
    st.header("ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ ÙˆØªØµÙ†ÙŠÙ ABC Ø§Ù„Ø°ÙƒÙŠ")
    
    # Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„ØªØµÙ†ÙŠÙ
    temp_df = st.session_state.df.copy()
    temp_df['Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø³Ù†ÙˆÙŠØ©'] = temp_df['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * 365 * temp_df['Ø§Ù„Ø³Ø¹Ø±']
    total_value = temp_df['Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø³Ù†ÙˆÙŠØ©'].sum()
    
    def abc_classify(val):
        ratio = val / total_value
        if ratio > 0.6: return 'A (Ø­Ø±Ø¬ Ø¬Ø¯Ø§Ù‹)'
        elif ratio > 0.2: return 'B (Ù…ØªÙˆØ³Ø·)'
        else: return 'C (Ø«Ø§Ù†ÙˆÙŠ)'
    
    temp_df['ØªØµÙ†ÙŠÙ_ABC'] = temp_df['Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø³Ù†ÙˆÙŠØ©'].apply(abc_classify)
    
    st.write("ØªÙ… ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¢Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù‡Ù…ÙŠØªÙ‡Ø§ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© (Annual Consumption Value):")
    edited_df = st.data_editor(temp_df, num_rows="dynamic", use_container_width=True)
    
    if st.button("ğŸ’¾ Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©"):
        st.session_state.df = edited_df.drop(columns=['Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø³Ù†ÙˆÙŠØ©', 'ØªØµÙ†ÙŠÙ_ABC'])
        st.success("ØªÙ… ØªØ­Ø¯ÙŠØ« " + str(len(edited_df)) + " ØµÙ†ÙØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­!")
    
    

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 2: Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù…Ø¹ "Ù…Ø¤Ø´Ø± Ø§Ù„ØµØ­Ø©" ---
elif menu == "ğŸ“Š Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ":
    st.header("ğŸ“Š Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ")
    sel_p = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù:", st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'].unique())
    p = st.session_state.df[st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'] == sel_p].iloc[0]
    
    # Ø­Ø³Ø§Ø¨Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
    eoq = np.sqrt((2 * p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * 365 * p['S']) / p['H'])
    rop = p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * p['LT']
    health_score = min(100, int((p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'] / (rop * 1.5)) * 100))
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", f"{int(p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'])}")
    c2.metric("Ù†Ù‚Ø·Ø© Ø§Ù„Ø·Ù„Ø¨ (ROP)", f"{int(rop)}")
    c3.metric("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© (EOQ)", f"{int(eoq)}")
    c4.metric("Ù…Ø¤Ø´Ø± Ø§Ù„ØµØ­Ø© Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ©", f"{health_score}%")

    # Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
    days = np.arange(0, 20)
    stock_line = p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'] - (p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * days)
    stock_line = np.maximum(0, stock_line)
    
    fig = go.Figure()
    fig.add_trace(go.Scatter(x=days, y=stock_line, name='Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹', line=dict(color='royalblue', width=4)))
    fig.add_hline(y=rop, line_dash="dash", line_color="red", annotation_text="Ù†Ù‚Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨")
    fig.update_layout(title=f"Ù…Ù†Ø­Ù†Ù‰ Ù†ÙØ§Ø° Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù€ {sel_p}", xaxis_title="Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", yaxis_title="Ø§Ù„ÙƒÙ…ÙŠØ©")
    st.plotly_chart(fig, use_container_width=True)

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 3: Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ (Stress Test) - Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙˆÙŠØ© ---
elif menu == "ğŸ”¬ Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ (Stress Test)":
    st.header("ğŸ”¬ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…Ù„ Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯ (Supply Chain Stress Test)")
    st.warning("Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­Ø§ÙƒÙŠ ÙˆÙ‚ÙˆØ¹ ÙƒÙˆØ§Ø±Ø« Ù„ÙˆØ¬Ø³ØªÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯Ù‰ Ù…Ø±ÙˆÙ†Ø© Ù…ØµÙ†Ø¹Ùƒ.")
    
    sel_p = st.selectbox("Ø§Ø®ØªØ¨Ø± Ù…Ù†ØªØ¬Ùƒ Ø¶Ø¯ Ø§Ù„Ø£Ø²Ù…Ø§Øª:", st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'].unique())
    p = st.session_state.df[st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'] == sel_p].iloc[0]
    
    scenario = st.radio("Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø²Ù…Ø©:", ["ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ", "ØªØ£Ø®Ø± Ù…ÙˆØ±Ø¯ (Double Lead Time)", "Ø·ÙØ±Ø© Ø·Ù„Ø¨ Ù…ÙØ§Ø¬Ø¦Ø© (+100%)"])
    
    sim_lt = p['LT'] * 2 if scenario == "ØªØ£Ø®Ø± Ù…ÙˆØ±Ø¯ (Double Lead Time)" else p['LT']
    sim_sales = p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * 2 if scenario == "Ø·ÙØ±Ø© Ø·Ù„Ø¨ Ù…ÙØ§Ø¬Ø¦Ø© (+100%)" else p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ']
    
    # Ø­Ø³Ø§Ø¨ ÙŠÙˆÙ… Ø§Ù„Ø³Ù‚ÙˆØ· (Stockout Day)
    stockout_day = p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'] / sim_sales
    
    st.subheader("ğŸ“¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©:")
    if stockout_day < sim_lt:
        st.error(f"ğŸš¨ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø³ÙŠÙ†ÙØ¯ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… {int(stockout_day)}ØŒ Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„Ø´Ø­Ù†Ø© Ø³ØªØµÙ„ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… {int(sim_lt)}.")
        st.write("**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­:** Ø²ÙŠØ§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£Ù…Ø§Ù† (Safety Stock) ÙÙˆØ±Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù.")
    else:
        st.success(f"âœ… Ù†Ø¬Ø§Ø­: Ù…Ø®Ø²ÙˆÙ†Ùƒ Ù…Ø±Ù† Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ Ù„ØªØ­Ù…Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ù…Ø© Ù„Ù…Ø¯Ø© {int(stockout_day)} Ø£ÙŠØ§Ù….")

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 4 Ùˆ 5 (Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©) ---
# ØªØ¸Ù„ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø±Ø³ÙˆÙ…...
