import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ (ูุฌุจ ุฃู ุชููู ูู ุงูุจุฏุงูุฉ)
st.set_page_config(page_title="Ecotrak Digital Twin Pro", layout="wide", page_icon="๐")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ ุจุดูู ูุณุชูุฑ
if 'main_df' not in st.session_state:
    st.session_state.main_df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช ุตูุงุนูุฉ', 'ุงูุณุญุจ_ุงููููู': 15, 'ุงููุฎุฒูู': 65, 'ุงูุณุนุฑ': 12000, 'ุงูุชูููุฉ': 8500, 'S': 1500, 'H': 400, 'LT': 12, 'ุฃูุงู_ุงูุฑููุฏ': 5},
        {'ุงูููุชุฌ': 'ูุณุชุดุนุฑุงุช ูุงูู', 'ุงูุณุญุจ_ุงููููู': 45, 'ุงููุฎุฒูู': 120, 'ุงูุณุนุฑ': 1200, 'ุงูุชูููุฉ': 700, 'S': 200, 'H': 30, 'LT': 5, 'ุฃูุงู_ุงูุฑููุฏ': 2}
    ])

# 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ุงููุณุชูุฑุฉ
st.sidebar.title("๐ Ecotrak Neural ERP")
menu = st.sidebar.selectbox("ุงูุงูุชูุงู ุฅูู ุงูููุธููุฉ:", 
    ["๐ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช", "๐ ุงูุชูุฃู ุงูุฑููู (Deep Analysis)", "๐ง ูุฑูุฒ ุงูุชูุจุค ุงูุงุณุชุจุงูู", "๐ฑ ุงูุงุณุชุฏุงูุฉ"],
    key="nav_menu")

# --- ุงููุงุฆูุฉ 1: ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช":
    st.header("๐ ุฅุฏุงุฑุฉ ุฃุตูู ุงูููุดุฃุฉ")
    # ุงุณุชุฎุฏุงู key ูุฑูุฏ ูููุน ุงูุชุนููู
    edited_df = st.data_editor(st.session_state.main_df, num_rows="dynamic", use_container_width=True, key="main_editor_v8")
    if st.button("๐พ ุญูุธ ูุชุญุฏูุซ ุงููุธุงู", key="save_main"):
        st.session_state.main_df = edited_df
        st.success("ุชู ุงูุชุฒุงูู!")
        st.rerun()

# --- ุงููุงุฆูุฉ 2: ุงูุชูุฃู ุงูุฑููู (ุงูุชูุงุตูู ุงูุนูููุฉ) ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู (Deep Analysis)":
    st.header("๐ ุงูุชูุฃู ุงูุฑููู: ุชุญููู ุงูุฃูุธูุฉ ูุงูุชุฏููุงุช")
    df = st.session_state.main_df
    
    if not df.empty:
        # ุงุฎุชูุงุฑ ุงูููุชุฌ ููุชุญููู ุงูุนููู
        sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุงู (ุงูููุชุฌ) ููุญุงูุงุชู:", df['ุงูููุชุฌ'].unique(), key="twin_select")
        p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
        
        # --- ุงูุญุณุงุจุงุช ุงูููุฏุณูุฉ ุงูุฎูููุฉ ---
        eoq = np.sqrt((2 * p['ุงูุณุญุจ_ุงููููู'] * 365 * p['S']) / p['H'])
        rop = p['ุงูุณุญุจ_ุงููููู'] * p['LT'] # ููุทุฉ ุฅุนุงุฏุฉ ุงูุทูุจ
        days_to_zero = p['ุงููุฎุฒูู'] / p['ุงูุณุญุจ_ุงููููู'] if p['ุงูุณุญุจ_ุงููููู'] > 0 else 0
        turnover_rate = (p['ุงูุณุญุจ_ุงููููู'] * 365) / p['ุงููุฎุฒูู'] if p['ุงููุฎุฒูู'] > 0 else 0
        
        # --- ุงูุตู ุงูุฃูู: ุงููุคุดุฑุงุช ุงูุญูููุฉ (Vital Signs) ---
        c1, c2, c3, c4 = st.columns(4)
        c1.metric("ูุคุดุฑ ุงูุชุบุทูุฉ", f"{int(days_to_zero)} ููู", delta="ุญุฑุฌ" if days_to_zero < p['LT'] else "ุขูู")
        c2.metric("ูุนุฏู ุงูุฏูุฑุงู ุงูุณููู", f"{turnover_rate:.1f}x")
        c3.metric("ููุทุฉ ุฅุนุงุฏุฉ ุงูุทูุจ", f"{int(rop)} ูุญุฏุฉ")
        c4.metric("ูููุฉ ุงูุทูุจ ุงูุงูุชุตุงุฏู", f"{int(eoq)} ูุญุฏุฉ")

        st.divider()

        # --- ุงูุตู ุงูุซุงูู: ุงูุฑุณูู ุงูุจูุงููุฉ ุงูุชูุงุนููุฉ ---
        col_left, col_right = st.columns(2)
        
        with col_left:
            st.subheader("๐ ูุญุงูุงุฉ ุงุณุชูุฒุงู ุงููุฎุฒูู")
            # ุฑุณู ุจูุงูู ุฒููู
            days = np.arange(0, int(days_to_zero) + 10)
            levels = np.maximum(0, p['ุงููุฎุฒูู'] - (p['ุงูุณุญุจ_ุงููููู'] * days))
            fig_stock = px.area(x=days, y=levels, title="ุงูุฌุฏูู ุงูุฒููู ุงููุชููุน ููููุงุฏ", labels={'x':'ุงูุฃูุงู ุงููุงุฏูุฉ', 'y':'ุงููููุฉ'})
            fig_stock.add_hline(y=rop, line_dash="dash", line_color="red", annotation_text="ููุทุฉ ุงูุทูุจ")
            st.plotly_chart(fig_stock, use_container_width=True, key="stock_chart")

        with col_right:
            st.subheader("๐ฐ ุชูุฒูุน ุชูุงููู ุงูุชุฎุฒูู vs ุงูุทูุจ")
            # ุฑุณู ุจูุงูู ุฏุงุฆุฑู ูุชูุฒูุน ุงูุชูุงููู
            total_S = (365 / (eoq/p['ุงูุณุญุจ_ุงููููู'])) * p['S']
            total_H = (eoq / 2) * p['H']
            fig_costs = px.pie(values=[total_S, total_H], names=['ุชูุงููู ุฃูุงูุฑ ุงูุดุฑุงุก', 'ุชูุงููู ุงูุงุญุชูุงุธ ุจุงููุฎุฒูู'], 
                               hole=0.4, title="ุชุญููู ููุงุกุฉ ุงูุชูููุฉ (EOQ Model)")
            st.plotly_chart(fig_costs, use_container_width=True, key="cost_chart")

        # --- ุงูุตู ุงูุซุงูุซ: ุชุญููู ุงููุฎุงุทุฑ ุงูุงุณุชุจุงูู ---
        st.divider()
        st.subheader("๐ก๏ธ ุชูุฑูุฑ ุงูุญุงูุฉ ุงูุชุดุบูููุฉ (System Health Report)")
        
        audit_col1, audit_col2 = st.columns(2)
        with audit_col1:
            if days_to_zero < p['LT']:
                st.error(f"๐จ **ูุฌูุฉ ุชูุฑูุฏ:** ุงููุฎุฒูู ุณูููุฏ ูุจู ูุตูู ุงูุดุญูุฉ ุงููุงุฏูุฉ ุจู {int(p['LT'] - days_to_zero)} ุฃูุงู.")
            else:
                st.success(f"โ **ุณูุงุณู ุฅูุฏุงุฏ ูุณุชูุฑุฉ:** ุงููุฎุฒูู ูุบุทู ูุชุฑุฉ ุงูุชูุฑูุฏ ุจุฒูุงุฏุฉ {int(days_to_zero - p['LT'])} ุฃูุงู.")
        
        with audit_col2:
            if p['ุงููุฎุฒูู'] > eoq * 1.5:
                st.warning("โ๏ธ **ุชูุฏุณ ูุงูู:** ูุฏูู ูุงุฆุถ ูุฎุฒูู ูุนุทู ุงูุณูููุฉ ุงูููุฏูุฉ. ููุตู ุจุชูููู ุงูุทูุจูุฉ ุงููุงุฏูุฉ.")
            else:
                st.info("๐ **ููุงุกุฉ ููุฏูุฉ:** ุญุฌู ุงููุฎุฒูู ุงูุญุงูู ูุชูุงุณุจ ูุน ูุนุฏูุงุช ุงูุณุญุจ ุงูููููุฉ.")

    else:
        st.error("ุงูุฑุฌุงุก ุฅุถุงูุฉ ุจูุงูุงุช ูู ูุงุฆูุฉ ุงูุฅุฏุงุฑุฉ ุฃููุงู.")

# --- ุงูููุงุฆู ุงูุฃุฎุฑู (ุชุธู ูุงูุณุงุจู ูุน ุถูุงู Keys ูุฑูุฏุฉ) ---
elif menu == "๐ง ูุฑูุฒ ุงูุชูุจุค ุงูุงุณุชุจุงูู":
    st.header("๐ง ูุฑูุฒ ุงูุชูุจุค ููุนุงูุฌุฉ ุงููุดููุงุช")
    # (ููุฏ ุงูุชูุจุค ุงูุณุงุจู ูุน ุฅุถุงูุฉ ููุงุชูุญ ูุฑูุฏุฉ)
