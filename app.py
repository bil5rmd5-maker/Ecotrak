import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©
st.set_page_config(page_title="Ecotrak Neural ERP", layout="wide", page_icon="ðŸ§ ")

# 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© (Session State) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Error Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„
if 'df' not in st.session_state:
    st.session_state.df = pd.DataFrame([
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'Ù…Ø­Ø±ÙƒØ§Øª ØªÙˆØ±Ø¨ÙŠÙ†ÙŠØ©', 'Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ': 12, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 45, 'Ø§Ù„Ø³Ø¹Ø±': 8000, 'ØªÙƒÙ„ÙØ©_Ø§Ù„Ø·Ù„Ø¨': 1200, 'ØªÙƒÙ„ÙØ©_Ø§Ù„ØªØ®Ø²ÙŠÙ†': 200, 'Ù…Ø¯Ø©_Ø§Ù„ØªÙˆØ±ÙŠØ¯': 10},
        {'Ø§Ù„Ù…Ù†ØªØ¬': 'ÙˆØ­Ø¯Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ': 35, 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†': 120, 'Ø§Ù„Ø³Ø¹Ø±': 1500, 'ØªÙƒÙ„ÙØ©_Ø§Ù„Ø·Ù„Ø¨': 300, 'ØªÙƒÙ„ÙØ©_Ø§Ù„ØªØ®Ø²ÙŠÙ†': 45, 'Ù…Ø¯Ø©_Ø§Ù„ØªÙˆØ±ÙŠØ¯': 5}
    ])

# 3. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
st.sidebar.title("ðŸ§  Ecotrak Neural AI")
menu = st.sidebar.radio("Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©:", 
    ["ðŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", "ðŸ“Š Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ", "ðŸ”® Ù…Ø­Ø§ÙƒÙŠ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª", "ðŸšš Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", "ðŸŒ± Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©"])

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ) ---
if menu == "ðŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª":
    st.header("ðŸ“‹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ø£ØµÙ†Ø§Ù")
    st.write("Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø®Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ· 'Ø­ÙØ¸' Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.")
    
    # Ù…Ø­Ø±Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
    edited_df = st.data_editor(st.session_state.df, num_rows="dynamic", use_container_width=True, key="editor")
    
    if st.button("ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…"):
        st.session_state.df = edited_df
        st.success("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
        st.rerun()

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 2: Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ (ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ØµÙ†Ù) ---
elif menu == "ðŸ“Š Ø§Ù„ØªÙˆØ£Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠ":
    st.header("ðŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø­Ø¸ÙŠ ÙˆØ¯Ø¹Ù… Ø§Ù„Ù‚Ø±Ø§Ø±")
    
    if not st.session_state.df.empty:
        p_names = st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'].unique()
        sel_p = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ØªØ­Ù„ÙŠÙ„:", p_names)
        p = st.session_state.df[st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'] == sel_p].iloc[0]
        
        # Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ù†Ø¯Ø³ÙŠØ© (EOQ & Reorder Point)
        # EOQ = sqrt(2DS/H)
        eoq = np.sqrt((2 * p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * 365 * p['ØªÙƒÙ„ÙØ©_Ø§Ù„Ø·Ù„Ø¨']) / p['ØªÙƒÙ„ÙØ©_Ø§Ù„ØªØ®Ø²ÙŠÙ†'])
        reorder_point = p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] * p['Ù…Ø¯Ø©_Ø§Ù„ØªÙˆØ±ÙŠØ¯']
        days_left = p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'] / p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] if p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] > 0 else 0
        
        c1, c2, c3 = st.columns(3)
        c1.metric("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ", f"{int(p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'])} Ù‚Ø·Ø¹Ø©")
        c2.metric("Ø£ÙŠØ§Ù… Ø§Ù„ØªØºØ·ÙŠØ©", f"{int(days_left)} ÙŠÙˆÙ…")
        c3.metric("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© (EOQ)", f"{int(eoq)} ÙˆØ­Ø¯Ø©")
        
        # Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ
        fig = go.Figure(go.Indicator(
            mode = "gauge+number", value = p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'],
            title = {'text': f"Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù€ {sel_p}"},
            gauge = {
                'axis': {'range': [0, max(eoq*1.5, p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†']+10)]},
                'steps': [{'range': [0, reorder_point], 'color': "#FF4B4B"}],
                'threshold': {'line': {'color': "black", 'width': 4}, 'value': reorder_point}
            }))
        st.plotly_chart(fig, use_container_width=True)
        
        st.markdown("---")
        st.subheader("ðŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ:")
        if p['Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'] <= reorder_point:
            st.error(f"âš ï¸ ÙˆØ¶Ø¹ Ø­Ø±Ø¬: Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø§ ÙŠØºØ·ÙŠ ÙØªØ±Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯. ÙŠÙˆØµÙ‰ Ø¨Ø·Ù„Ø¨ Ø´Ø­Ù†Ø© ÙÙˆØ±ÙŠØ©.")
        else:
            st.success(f"âœ… ÙˆØ¶Ø¹ Ù…Ø³ØªÙ‚Ø±: Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØºØ·ÙŠ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ù„Ù€ {int(days_left)} ÙŠÙˆÙ…Ø§Ù‹.")
    else:
        st.warning("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.")

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 3: Ù…Ø­Ø§ÙƒÙŠ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª (ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª) ---
elif menu == "ðŸ”® Ù…Ø­Ø§ÙƒÙŠ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª":
    st.header("ðŸ”® Ù…Ø¹Ù…Ù„ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª (What-If Analysis)")
    if not st.session_state.df.empty:
        sel_p = st.selectbox("ØµÙ†Ù Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©:", st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'].unique())
        p = st.session_state.df[st.session_state.df['Ø§Ù„Ù…Ù†ØªØ¬'] == sel_p].iloc[0]
        
        col_in, col_out = st.columns([1, 2])
        with col_in:
            st.subheader("ðŸ› ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª")
            price_change = st.slider("ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (%)", -50, 50, 0)
            ship_cost = st.slider("ØªØ¹Ø¯ÙŠÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ù„Ø¨ÙŠØ© (S)", 50, 5000, int(p['ØªÙƒÙ„ÙØ©_Ø§Ù„Ø·Ù„Ø¨']))
            
            # Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø±ÙˆÙ†Ø© Ø§Ù„Ø·Ù„Ø¨: Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ù‚Ù„ = Ø³Ø­Ø¨ Ø£Ø¹Ù„Ù‰
            new_price = p['Ø§Ù„Ø³Ø¹Ø±'] * (1 + price_change/100)
            elasticity = 1.5
            new_sales = p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'] / ((new_price / p['Ø§Ù„Ø³Ø¹Ø±']) ** elasticity)
            new_eoq = np.sqrt((2 * new_sales * 365 * ship_cost) / p['ØªÙƒÙ„ÙØ©_Ø§Ù„ØªØ®Ø²ÙŠÙ†'])

        with col_out:
            st.subheader("ðŸ“ˆ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©")
            st.write(f"Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: **{new_sales:.1f}** ÙˆØ­Ø¯Ø©")
            st.write(f"Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: **{int(new_eoq)}** Ù‚Ø·Ø¹Ø©")
            
            # Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ ØªÙˆØ¶ÙŠØ­ÙŠ
            fig_sim = px.line(x=[p['Ø§Ù„Ø³Ø¹Ø±']*0.7, p['Ø§Ù„Ø³Ø¹Ø±'], p['Ø§Ù„Ø³Ø¹Ø±']*1.3], 
                              y=[p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ']*1.5, p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ'], p['Ø§Ù„Ø³Ø­Ø¨_Ø§Ù„ÙŠÙˆÙ…ÙŠ']*0.6],
                              title="Ù…Ù†Ø­Ù†Ù‰ Ù…Ø±ÙˆÙ†Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø³Ø¹Ø± vs Ø§Ù„Ø³Ø­Ø¨)")
            fig_sim.add_vline(x=new_price, line_dash="dash", line_color="red")
            st.plotly_chart(fig_sim, use_container_width=True)
    else:
        st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©.")

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 4: Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠØ© ---
elif menu == "ðŸšš Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†":
    st.header("ðŸšš Ø±Ø§Ø¯Ø§Ø± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¹Ø¯Ø¯")
    vendors = pd.DataFrame({
        'Ø§Ù„Ù…ÙˆØ±Ø¯': ['Ù…Ø­Ù„ÙŠ (Ø³Ø±Ø¹Ø©)', 'Ø¥Ù‚Ù„ÙŠÙ…ÙŠ (ØªÙˆØ§Ø²Ù†)', 'Ø¯ÙˆÙ„ÙŠ (ØªÙˆÙÙŠØ±)', 'Ø£Ù„Ù…Ø§Ù†ÙŠ (Ø¬ÙˆØ¯Ø©)'],
        'Ø£ÙŠØ§Ù…_Ø§Ù„ØªÙˆØµÙŠÙ„': [2, 7, 25, 14],
        'ØªÙƒÙ„ÙØ©_Ø§Ù„Ø´Ø­Ù†': [500, 1200, 200, 3500],
        'Ø¯Ø±Ø¬Ø©_Ø§Ù„Ø¬ÙˆØ¯Ø©': [80, 90, 75, 99],
        'Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©': ['Ù…Ù…ØªØ§Ø²', 'Ø¬ÙŠØ¯', 'Ø¶Ø¹ÙŠÙ', 'Ù…Ù…ØªØ§Ø²']
    })
    
    st.table(vendors)
    
    st.markdown("---")
    st.subheader("ðŸ” Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø°ÙƒÙŠ:")
    st.write("1. Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª **Ø§Ù„Ø­Ø±Ø¬Ø©**: Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯ 'Ø§Ù„Ù…Ø­Ù„ÙŠ' Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬.")
    st.write("2. Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª **Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù‚ÙŠÙ…Ø©**: Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯ 'Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ' Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚Ù„ Ù†Ø³Ø¨Ø© Ø¹ÙŠÙˆØ¨.")
    st.write("3. Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª **Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠØ©**: Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯ 'Ø§Ù„Ø¯ÙˆÙ„ÙŠ' Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©.")

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© 5: Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© ---
elif menu == "ðŸŒ± Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©":
    st.header("ðŸŒ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø¨ÙŠØ¦ÙŠ ÙˆØ§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø³ØªØ¯Ø§Ù…Ø©")
    st.markdown("")
    st.metric("ØªÙˆÙÙŠØ± Ø§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©", "24.5 ÙƒØ¬Ù…", "+18%")
    st.info("ðŸ¤– **Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø³ØªØ´Ø§Ø±:** ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø¹Ø¨Ø± ØªØ­Ø³ÙŠÙ† EOQ ÙŠØ³Ø§Ù‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø®ÙØ¶ Ø§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ© Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠ.")
