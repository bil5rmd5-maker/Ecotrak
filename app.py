import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ ุงูุงุญุชุฑุงููุฉ
st.set_page_config(page_title="Ecotrak Neural AI - Prediction Engine", layout="wide", page_icon="๐ฎ")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ
if 'df' not in st.session_state:
    st.session_state.df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช ุตูุงุนูุฉ', 'ุงูุณุญุจ_ุงููููู': 15, 'ุงููุฎุฒูู': 60, 'ุงูุณุนุฑ': 12000, 'ุงูุชูููุฉ_ุงููููุฉ': 8500, 'S': 1500, 'H': 400, 'LT': 12},
        {'ุงูููุชุฌ': 'ูุณุชุดุนุฑุงุช ูุงูู', 'ุงูุณุญุจ_ุงููููู': 45, 'ุงููุฎุฒูู': 200, 'ุงูุณุนุฑ': 1200, 'ุงูุชูููุฉ_ุงููููุฉ': 700, 'S': 200, 'H': 30, 'LT': 5}
    ])

# 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
st.sidebar.title("๐ฎ Ecotrak AI Brain")
menu = st.sidebar.radio("ุงูุฃูุธูุฉ ุงูุฐููุฉ:", 
    ["๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช", "๐ ุงูุชูุฃู ุงูุฑููู", "๐ ูุญุงูู ุงูุฃุฑุจุงุญ ูุงูุชูุจุค", "๐ฌ ุงุฎุชุจุงุฑ ุงูุฅุฌูุงุฏ", "๐ฑ ุงูุงุณุชุฏุงูุฉ"])

# --- ุงููุงุฆูุฉ 1: ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช ---
if menu == "๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช":
    st.header("๐ ุฅุฏุงุฑุฉ ุฃุตูู ุงูููุดุฃุฉ")
    edited_df = st.data_editor(st.session_state.df, num_rows="dynamic", use_container_width=True)
    if st.button("๐พ ุญูุธ ุงูุจูุงูุงุช"):
        st.session_state.df = edited_df
        st.success("ุชู ุงูุชุญุฏูุซ!")

# --- ุงููุงุฆูุฉ 3: ูุญุงูู ุงูุฃุฑุจุงุญ ูุงูุชูุจุค (ุงูููุฒุฉ ุงููุทููุจุฉ) ---
elif menu == "๐ ูุญุงูู ุงูุฃุฑุจุงุญ ูุงูุชูุจุค":
    st.header("๐ ูุญุฑู ุงูุชูุจุค ุงููุงูู ูุงุญุชูุงูุงุช ุงููุฌุงุญ")
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ููุชูุจุค ุจูุณุชูุจูู:", st.session_state.df['ุงูููุชุฌ'].unique())
    p = st.session_state.df[st.session_state.df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    col_ctrl, col_res = st.columns([1, 2])
    
    with col_ctrl:
        st.subheader("๐๏ธ ูุนุงููุฑ ุงูุณูู")
        market_trend = st.slider("ููู ุงูุทูุจ ุงูููุงุฌุฆ (%)", -50, 200, 0)
        expected_price = st.number_input("ุณุนุฑ ุงูุจูุน ุงููุณุชูุฏู", value=float(p['ุงูุณุนุฑ']))
        
        # ุญุณุงุจุงุช ุงูุชูุจุค
        new_demand = p['ุงูุณุญุจ_ุงููููู'] * (1 + market_trend/100)
        total_revenue = new_demand * 30 * expected_price
        total_cost = (new_demand * 30 * p['ุงูุชูููุฉ_ุงููููุฉ']) + (p['S'] * (30/p['LT']))
        profit = total_revenue - total_cost
        margin = (profit / total_revenue) * 100 if total_revenue > 0 else 0

    with col_res:
        st.subheader("๐ฎ ุชูุฑูุฑ ุงูุชูุจุค ุงูุฐูู")
        
        # ุฎูุงุฑุฒููุฉ ุงุญุชูุงููุฉ ุงููุฌุงุญ (ูุจููุฉ ุนูู ุงููุงูุด ูุฏูุฑุงู ุงููุฎุฒูู)
        success_rate = min(100, max(0, int(margin + (new_demand * 2))))
        
        c1, c2 = st.columns(2)
        c1.metric("ุงุญุชูุงููุฉ ูุฌุงุญ ุงูููุชุฌ", f"{success_rate}%")
        c2.metric("ุตุงูู ุงูุฑุจุญ ุงููุชููุน (ุดูุฑูุงู)", f"{int(profit):,} ุฑูุงู", delta=f"{margin:.1f}% ูุงูุด")

        if success_rate > 70:
            st.success("๐ **ุชูุจุค ุฅูุฌุงุจู:** ุงูููุชุฌ ูุธูุฑ ูุคุดุฑุงุช ูููุฉ ูููุฌุงุญ. ููุตู ุจุฒูุงุฏุฉ ุฎุทูุท ุงูุฅูุชุงุฌ.")
        elif success_rate > 40:
            st.warning("โ๏ธ **ุชูุจุค ูุชูุณุท:** ุงูููุชุฌ ูุณุชูุฑ ูููู ุงูุฑุจุญูุฉ ุญุณุงุณุฉ ูุชุบูุฑ ุชูุงููู ุงูุดุญู.")
        else:
            st.error("โ๏ธ **ุชูุจูู ุฎุทุฑ:** ุงุญุชูุงููุฉ ูุดู ุนุงููุฉ. ุงูุชูุงููู ุงูุชุดุบูููุฉ ุชุฃูู ุงููุงูุด ุงูุฑุจุญู.")

        # ุฑุณู ุจูุงูู ููุฑุจุญ ูุงูุฎุณุงุฑุฉ (Break-even Analysis)
        
        units = np.linspace(0, new_demand * 60, 20)
        rev_line = units * expected_price
        cost_line = (units * p['ุงูุชูููุฉ_ุงููููุฉ']) + p['S']
        
        fig_be = go.Figure()
        fig_sim = px.line(x=units, y=[rev_line, cost_line], 
                          labels={'value': 'ุงููุจูุบ (ุฑูุงู)', 'x': 'ุงููููุฉ ุงููุจุงุนุฉ'},
                          title="ุชุญููู ููุทุฉ ุงูุชุนุงุฏู (Break-even Point)")
        st.plotly_chart(fig_sim, use_container_width=True)

# --- ุงููุงุฆูุฉ 2: ุงูุชูุฃู ุงูุฑููู ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู":
    st.header("๐ ุญุงูุฉ ุงูุชุฏููุงุช ุงููุญุธูุฉ")
    # (ุฅุถุงูุฉ ุฑุณูู Gauge Chart ุงูุณุงุจูุฉ ููุง ูุถูุงู ุงุณุชูุฑุงุฑ ุงูุนุฑุถ)
    
    st.info("ููุงุญุธุฉ: ูุฐุง ุงููุณู ูุฑุจุท ุจูุงูุงุช ุงููุฎุฒูู ุจููุทุฉ ุงูุทูุจ ุงููุซุงููุฉ ูุถูุงู ุนุฏู ุชููู ุงููุจูุนุงุช.")

# --- ุงููุงุฆูุฉ 4: ุงูุงุณุชุฏุงูุฉ ---
elif menu == "๐ฑ ุงูุงุณุชุฏุงูุฉ":
    st.header("๐ฑ ูุคุดุฑุงุช ุงูุงุณุชุฏุงูุฉ ุงูุจูุฆูุฉ")
    
    st.write("ุชูููู ุฑุญูุงุช ุงูุดุญู ุนุจุฑ EOQ ูุณุงูู ูู ุฎูุถ ุงูุจุนุงุซุงุช ุงููุฑุจูู.")
