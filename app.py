import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ
st.set_page_config(page_title="Ecotrak Neural Pro - Solution Edition", layout="wide", page_icon="๐ง")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ (ุฃุถููุง ุนููุฏ 'ุขุฎุฑ_ุชุญุฑู' ููุญุงูุงุฉ ุงูุฑููุฏ)
if 'main_df' not in st.session_state:
    st.session_state.main_df = pd.DataFrame([
        {'ุงูููุชุฌ': 'ุชูุฑุจููุงุช ุตูุงุนูุฉ', 'ุงูุณุญุจ_ุงููููู': 15, 'ุงููุฎุฒูู': 60, 'ุงูุณุนุฑ': 12000, 'ุงูุชูููุฉ': 8500, 'S': 1500, 'H': 400, 'LT': 12, 'ุฃูุงู_ุงูุฑููุฏ': 5},
        {'ุงูููุชุฌ': 'ูุณุชุดุนุฑุงุช ูุงูู', 'ุงูุณุญุจ_ุงููููู': 2, 'ุงููุฎุฒูู': 500, 'ุงูุณุนุฑ': 1200, 'ุงูุชูููุฉ': 700, 'S': 200, 'H': 30, 'LT': 5, 'ุฃูุงู_ุงูุฑููุฏ': 120}
    ])

# --- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ---
st.sidebar.title("๐ Ecotrak Control")
menu = st.sidebar.selectbox("ุงูููุงุฆู:", 
    ["๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช", "๐ ุงูุชูุฃู ุงูุฑููู", "๐ง ูุฑูุฒ ุงูุชูุจุค ุงูุงุณุชุจุงูู", "๐ฌ ุงุฎุชุจุงุฑ ุงูุฅุฌูุงุฏ", "๐ฑ ุงูุงุณุชุฏุงูุฉ"])

# --- ุงููุงุฆูุฉ 1: ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ูุญุฑุฑ ุงูุจูุงูุงุช) ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช":
    st.header("๐ ุฅุฏุงุฑุฉ ุฃุตูู ุงูููุดุฃุฉ")
    edited_df = st.data_editor(st.session_state.main_df, num_rows="dynamic", use_container_width=True, key="editor_v2")
    if st.button("๐พ ุญูุธ ุงูุจูุงูุงุช"):
        st.session_state.main_df = edited_df
        st.success("ุชู ุงูุชุญุฏูุซ!")
        st.rerun()

# --- ุงููุงุฆูุฉ ุงูุฌุฏูุฏุฉ: ูุฑูุฒ ุงูุชูุจุค ุงูุงุณุชุจุงูู (ุญู ุงููุดููุงุช ุงูุญููููุฉ) ---
elif menu == "๐ง ูุฑูุฒ ุงูุชูุจุค ุงูุงุณุชุจุงูู":
    st.header("๐ง ูุฑูุฒ ุงูุชูุจุค ููุนุงูุฌุฉ ุงููุดููุงุช ุงูููุฌุณุชูุฉ")
    df = st.session_state.main_df
    
    # 1. ุชุญููู ุฃุซุฑ ุงูุณูุท (Bullwhip Effect)
    st.subheader("๐ฉ ุฑุงุฏุงุฑ 'ุฃุซุฑ ุงูุณูุท' (ุชุฐุจุฐุจ ุงูุทูุจ)")
    
    
    col_a, col_b = st.columns([2, 1])
    with col_a:
        # ูุญุงูุงุฉ ุชุฐุจุฐุจ ุงูุทูุจ
        variation = st.slider("ูุณุจุฉ ุชุฐุจุฐุจ ุทูุจ ุงูุนููู (%)", 0, 100, 20)
        st.info(f"ุนูุฏ ุชุฐุจุฐุจ ุทูุจ ุงูุนููู ุจูุณุจุฉ {variation}%ุ ูุญุชุงุฌ ุงูููุฑุฏ ูุฒูุงุฏุฉ ูุฎุฒููู ุจูุณุจุฉ {variation * 2.5:.1f}% ูุชุฌูุจ ุงูููุงุฏ.")
    
    # 2. ุชุญููู ุงูุฑููุฏ (Dead Stock Radar)
    st.divider()
    st.subheader("๐ ุฑุงุฏุงุฑ ุงูุฑููุฏ ูุงููุฎุฒูู ุงูููุช")
    
    for index, row in df.iterrows():
        days_to_deplete = row['ุงููุฎุฒูู'] / row['ุงูุณุญุจ_ุงููููู'] if row['ุงูุณุญุจ_ุงููููู'] > 0 else 999
        
        c1, c2, c3 = st.columns([1, 2, 1])
        c1.write(f"**{row['ุงูููุชุฌ']}**")
        
        if row['ุฃูุงู_ุงูุฑููุฏ'] > 90:
            c2.error(f"ุชุญุฐูุฑ: ููุชุฌ ุฑุงูุฏ! ูู ูุชุญุฑู ููุฐ {row['ุฃูุงู_ุงูุฑููุฏ']} ููู.")
            c3.button(f"ุฎุทุฉ ุชุตููุฉ ูู {row['ุงูููุชุฌ']}", key=f"liq_{index}")
        elif days_to_deplete < row['LT']:
            c2.warning(f"ุฎุทุฑ ููุงุฏ: ุงููุฎุฒูู ูุบุทู {int(days_to_deplete)} ุฃูุงู ููุท.")
            c3.button(f"ุทูุจ ุงุณุชุซูุงุฆู ูู {row['ุงูููุชุฌ']}", key=f"ord_{index}")
        else:
            c2.success("ุงููุถุน ูุณุชูุฑ")
    
    

# --- ุงููุงุฆูุฉ 2: ุงูุชูุฃู ุงูุฑููู ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู":
    st.header("๐ ุงูุชุญูููุงุช ุงููุญุธูุฉ")
    df = st.session_state.main_df
    sel_p = st.selectbox("ุงุฎุชุฑ ุงูุตูู:", df['ุงูููุชุฌ'].unique())
    p = df[df['ุงูููุชุฌ'] == sel_p].iloc[0]
    
    # ุญุณุงุจุงุช EOQ
    eoq = np.sqrt((2 * p['ุงูุณุญุจ_ุงููููู'] * 365 * p['S']) / p['H'])
    st.metric("ุงููููุฉ ุงูุงูุชุตุงุฏูุฉ ุงูููุชุฑุญุฉ (EOQ)", f"{int(eoq)} ูุญุฏุฉ")
    
    

# --- ุจููุฉ ุงูููุงุฆู ุชุนูู ูุงูุณุงุจู ูุน ุถูุงู ุนุฏู ุงูุชุนููู ---
elif menu == "๐ฌ ุงุฎุชุจุงุฑ ุงูุฅุฌูุงุฏ":
    st.header("๐ฌ ูุนูู ุงูุฅุฌูุงุฏ")
    # (ููุฏ ุงุฎุชุจุงุฑ ุงูุฅุฌูุงุฏ ุงูุณุงุจู)

elif menu == "๐ฑ ุงูุงุณุชุฏุงูุฉ":
    st.header("๐ฑ ุชูุฑูุฑ ุงูุงุณุชุฏุงูุฉ")
    # (ููุฏ ุงูุงุณุชุฏุงูุฉ ุงูุณุงุจู)
