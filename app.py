import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ
st.set_page_config(page_title="Ecotrak - University Prototype", layout="wide")

# 2. ุชููุฆุฉ ุงูุจูุงูุงุช ุจุฃุณูุงุก ูุงุชูููุฉ ูุชุฌูุจ KeyError
if 'db' not in st.session_state:
    # ูุณุชุฎุฏู ุฃุณูุงุก ุฅูุฌููุฒูุฉ ุจุฑูุฌูุงู ูุชุฌูุจ ูุดุงูู ุงูุชุดููุฑ ูุงููุบุฉ
    st.session_state.db = pd.DataFrame([
        {'id': 1, 'name': 'ุตุงุจูู ูุงููุฏุฑ', 'demand': 45, 'stock': 350, 'price': 25.0, 'cost': 12.0, 's_cost': 150.0, 'h_cost': 2.0, 'waste': 3.0, 'lead_time': 3},
        {'id': 2, 'name': 'ููุธู ููููู', 'demand': 110, 'stock': 200, 'price': 15.0, 'cost': 7.0, 's_cost': 80.0, 'h_cost': 1.0, 'waste': 1.5, 'lead_time': 2}
    ])

# ุฏุงูุฉ ุงูุญุณุงุจ (EOQ)
def calc_eoq(d, s, h):
    try:
        return np.sqrt((2 * d * 365 * s) / h) if h > 0 else 0
    except:
        return 0

# --- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ---
st.sidebar.title("๐ง Ecotrak Neural ERP")
menu = st.sidebar.radio("ุงููุฎุฑุฌุงุช ุงููุทููุจุฉ:", 
    ["๐ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช (Data)", "๐ ุงูุชูุฃู ุงูุฑููู (Prototype)", "๐ ุงูุชูุงุฑูุฑ ุงููุงููุฉ (Insight)", "๐ ุฎุทุฉ ุงูุชูููุฐ (Action Plan)"])

# --- 1. ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ---
if menu == "๐ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช (Data)":
    st.header("๐ ูุฏุฎูุงุช ุงููุธุงู ูุชุนุฏูู ุงูุชูุงููู")
    # ุนุฑุถ ูุณููุงุช ุนุฑุจูุฉ ูููุณุชุฎุฏู ูุน ุจูุงุก ุงูุฃุตู ุฅูุฌููุฒู
    col_map = {
        'name': 'ุงูููุชุฌ', 'demand': 'ุงูุณุญุจ ุงููููู', 'stock': 'ุงููุฎุฒูู', 
        'price': 'ุณุนุฑ ุงูุจูุน', 'cost': 'ุงูุชูููุฉ', 's_cost': 'ุชูููุฉ ุงูุดุญู (S)', 
        'h_cost': 'ุชูููุฉ ุงูุชุฎุฒูู (H)', 'waste': 'ูุณุจุฉ ุงูุชูู %', 'lead_time': 'ูุฏุฉ ุงูุชูุฑูุฏ'
    }
    
    edited_df = st.data_editor(st.session_state.db.rename(columns=col_map), num_rows="dynamic", use_container_width=True)
    
    if st.button("๐พ ุญูุธ ุงูุจูุงูุงุช ูุชุญุฏูุซ ุงููุญุงูุงุฉ"):
        # ุฅุนุงุฏุฉ ุงูุชุณููุฉ ููุฃุตู ููุญูุธ
        reverse_map = {v: k for k, v in col_map.items()}
        st.session_state.db = edited_df.rename(columns=reverse_map)
        st.success("ุชู ุงูุชุญุฏูุซ! ููููู ุงูุขู ุงูุงูุชูุงู ููุณู ุงูุชูุฃู ุงูุฑููู.")
        st.rerun()

# --- 2. ุงูุชูุฃู ุงูุฑููู (ุงููููุฐุฌ ุงูุฃููู Prototype) ---
elif menu == "๐ ุงูุชูุฃู ุงูุฑููู (Prototype)":
    st.header("๐ ุงููุญุงูุงุฉ ุงููุญุธูุฉ (ุชุฃุซูุฑ ุงูุชูุงููู)")
    df = st.session_state.db
    sel_name = st.selectbox("ุงุฎุชุฑ ุงูููุชุฌ ูููุนููุฉ:", df['name'].unique())
    p = df[df['name'] == sel_name].iloc[0]
    
    # ุงูุญุณุงุจุงุช ุจุงุณุชุฎุฏุงู ุงูุฃุณูุงุก ุงูุฅูุฌููุฒูุฉ ุงูุจุฑูุฌูุฉ (ุชููุน ุงูุฎุทุฃ ุงูุธุงูุฑ ูู ุตูุฑุชู)
    eoq = calc_eoq(p['demand'], p['s_cost'], p['h_cost'])
    rop = p['demand'] * p['lead_time']
    
    c1, c2, c3 = st.columns(3)
    c1.metric("ุงููููุฉ ุงููุซุงููุฉ (EOQ)", f"{int(eoq)} ูุญุฏุฉ")
    c2.metric("ููุทุฉ ุฅุนุงุฏุฉ ุงูุทูุจ", f"{int(rop)} ูุญุฏุฉ")
    c3.metric("ูุณุชูู ุงููุฎุฒูู ุงูุญุงูู", f"{int(p['stock'])}")

    # ุงูุฑุณู ุงูุจูุงูู
    fig = go.Figure(go.Indicator(
        mode = "gauge+number", value = p['stock'],
        gauge = {'axis': {'range': [0, max(eoq, p['stock'])*1.2]},
                 'steps': [{'range': [0, rop], 'color': "red"}],
                 'threshold': {'line': {'color': "black", 'width': 4}, 'value': rop}}))
    st.plotly_chart(fig, use_container_width=True)

# --- 4. ุฎุทุฉ ุงูุชูููุฐ (ุจูุงุกู ุนูู ูุชุทูุจุงุช ุตูุฑุชู ุงููุฑููุฉ) ---
elif menu == "๐ ุฎุทุฉ ุงูุชูููุฐ (Action Plan)":
    st.header("๐ ุงูุฎุทุฉ ุงูุชูููุฐูุฉ ุงูููุชุฑุญุฉ ูููุดุฑูุน")
    st.markdown("""
    ### 1. ูุฑุญูุฉ ุฌูุน ุงูุจูุงูุงุช (Week 1)
    * ุญุตุฑ ุงูุฃุตูุงู ูุชุญุฏูุฏ ุชูุงููู ุงูุดุญู (S) ูุงูุชุฎุฒูู (H).
    ### 2. ูุฑุญูุฉ ุงูุจุฑูุฌุฉ ูุงููุญุงูุงุฉ (Week 2-3)
    * ุจูุงุก ุงูุฎูุงุฑุฒููุงุช (EOQ) ูุฑุจุทูุง ุจุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ (Streamlit).
    ### 3. ูุฑุญูุฉ ุงูุงุฎุชุจุงุฑ (Week 4)
    * ุงุฎุชุจุงุฑ ุฏูุฉ ุงูุชูุจุค ุจููุงุฏ ุงููุฎุฒูู ูุชุฌุฑุจุฉ ุงููุธุงู ูุน ูุณุชุฎุฏููู ุญูููููู.
    """)
    st.info("๐ก ููุง ูู ููุถุญ ูู ูุชุทูุจุงุช ุงูุฌุงูุนุฉ: ูุง ููุดุชุฑุท ุชูููุฐ ุงูุญู ุจุดูู ูุงููุ ูููู ูุฌุจ ุชูุฏูู ุฎุทุฉ ูุงุถุญุฉ.")
